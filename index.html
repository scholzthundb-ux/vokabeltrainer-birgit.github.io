<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vokabeltrainer (0‚Äì7 ¬∑ Player-Abfrage ¬∑ Fach 6/7 separat)</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#f6f7fb;color:#111}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid #e7e7ef;z-index:50}
    .wrap{max-width:980px;margin:0 auto;padding:14px 16px}
    h1{font-size:18px;margin:0}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .tab{border:1px solid #d8d9e6;background:#fff;border-radius:10px;padding:8px 10px;font-weight:700;cursor:pointer}
    .tab.active{background:#111;color:#fff;border-color:#111}
    main{padding:16px}
    .grid{display:grid;gap:12px}
    @media (min-width:860px){ .grid{grid-template-columns: 1.3fr 1fr} }
    .card{background:#fff;border:1px solid #e7e7ef;border-radius:14px;padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{font-size:12px;font-weight:800;color:#333}
    input[type="text"], textarea, select{
      width:100%;box-sizing:border-box;border:1px solid #d8d9e6;border-radius:12px;
      padding:10px 12px;font-size:14px;background:#fff
    }
    textarea{min-height:110px;resize:vertical}
    button{
      border:1px solid #d8d9e6;background:#fff;border-radius:12px;
      padding:10px 12px;font-weight:800;cursor:pointer
    }
    button.primary{background:#111;color:#fff;border-color:#111}
    button.danger{background:#b00020;color:#fff;border-color:#b00020}
    button.ghost{background:transparent}
    .muted{color:#666;font-size:12px}
    .small{font-size:12px}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{border:1px solid #eee;border-radius:12px;padding:10px}
    .itemTop{display:flex;gap:8px;align-items:flex-start;justify-content:space-between}
    .itemLeft{min-width:0}
    .front{font-weight:900}
    .back{color:#333;margin-top:4px}
    .pill{font-size:12px;border:1px solid #ddd;border-radius:999px;padding:3px 8px;background:#fafafa}
    .stars{display:flex;gap:6px;align-items:center;flex-wrap:wrap}

    .dotBtn{
      width:34px;height:34px;border-radius:999px;padding:0;
      display:inline-flex;align-items:center;justify-content:center;
      font-weight:950;line-height:1;border:1px solid #d8d9e6;background:#fff;
    }
    .dotBtn.active{background:#111;color:#fff;border-color:#111}

    .dotBtn.red{border-color:#b00020;color:#b00020;background:#fff}
    .dotBtn.red.active{background:#b00020;border-color:#b00020;color:#fff}

    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .kpi .box{border:1px solid #eee;border-radius:12px;padding:10px;background:#fff}
    .kpi .num{font-size:18px;font-weight:900}
    .divider{height:1px;background:#eee;margin:10px 0}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    details{border:1px solid #eee;border-radius:12px;padding:10px;background:#fff}
    summary{cursor:pointer;font-weight:900}
    .ok{color:#0a7a0a;font-weight:800}
    .warn{color:#b00020;font-weight:800}

    .bins{display:flex;gap:6px;flex-wrap:wrap}
    .bin{font-size:12px;border:1px solid #ddd;border-radius:999px;padding:4px 10px;background:#fafafa}
    .bin.red{border-color:#b00020;color:#b00020;background:#fff5f5}

    /* Lernkarte */
    .flashWrap{display:flex;flex-direction:column;gap:12px}
    .flashTop{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .flashCard{
      min-height: 44vh;
      display:flex;flex-direction:column;justify-content:center;align-items:center;
      border:1px solid #e7e7ef;border-radius:18px;background:#fff;
      padding:18px;text-align:center;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      cursor:pointer;
      position:relative;
      z-index:1;
      flex: 1 1 auto;
    }
    .flashPrompt{font-size:30px;font-weight:950;line-height:1.15;max-width:880px;word-break:break-word}
    .flashAnswer{
      margin-top:16px;font-size:22px;line-height:1.25;max-width:880px;word-break:break-word;
      color:#222;display:none;background:#f3f4f8;border:1px dashed #d8d9e6;border-radius:14px;padding:14px;width:100%;box-sizing:border-box;
    }
    .flashAnswer.show{display:block}
    .tapHint{margin-top:10px;font-size:12px;color:#666}

    /* Controls unten */
    .learnBar{
      position:sticky;
      bottom:10px;
      z-index:1000;
      background:rgba(246,247,251,0.96);
      backdrop-filter: blur(6px);
      border:1px solid #e7e7ef;
      border-radius:16px;
      padding:10px;
    }
    .flashControls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:center}
    .flashControls button{min-width:140px}
    .flashStars{display:flex;gap:6px;align-items:center;justify-content:center;flex-wrap:wrap;margin-top:8px}

    .fileRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input[type="file"]{max-width:100%}

    /* ====== Player-Vollbild nur w√§hrend laufender Abfrage ====== */
    body.playerActive header{display:none;}
    body.playerActive main.wrap{max-width:none; padding:0; margin:0;}
    body.playerActive main{padding:0;}

    #viewLearn.player{
      position: fixed;
      inset: 0;
      z-index: 9999;
      overflow: hidden;
      background: #f3efe3; /* helles Beige */
      padding: 12px;
      padding-top: calc(12px + env(safe-area-inset-top));
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
      box-sizing: border-box;
    }
    #viewLearn.player .card{background: transparent;border: none;padding: 0;}
    #viewLearn.player .flashWrap{height: 100%;display:flex;flex-direction:column;}
    #viewLearn.player .flashCard{
      flex: 1 1 auto;
      min-height: 0;
      background: #f3efe3;
      border-color: #e2dccb;
    }
    #viewLearn.player .flashAnswer{background:#efe7d4;border-color:#d8cfb7;}
    #viewLearn.player .learnBar{
      position: sticky;
      bottom: calc(10px + env(safe-area-inset-bottom));
      background: rgba(243,239,227,0.96);
      border-color: #e2dccb;
    }

    /* Im Player: oben nur Zur√ºck */
    #viewLearn.player .flashTop .row{display:none;}          /* Pills weg */
    #viewLearn.player #learnConfig{display:none !important;} /* Konfig weg */
    #viewLearn.player #learnHint{display:none !important;}   /* Hint weg */

    #viewLearn.player #btnBackToManage{
      border-color:#e2dccb;
      background: rgba(243,239,227,0.96);
      padding:10px 12px;
      border-radius:14px;
      font-weight:900;
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <h1>Vokabeltrainer</h1>
    <div class="tabs">
      <button class="tab active" id="tabManage">Eingabe & Verwaltung</button>
      <button class="tab" id="tabLearn">Abfrage</button>
      <button class="tab" id="tabData">Import/Export</button>
    </div>

    <div class="muted small" id="statusLine"></div>
    <div class="muted small" id="binsTop"></div>
    <div class="muted small" id="storageInfo"></div>
    <div class="muted small" id="jsAlive">JS: ‚Ä¶</div>
  </div>
</header>

<main class="wrap">
  <!-- Manage -->
  <div id="viewManage" class="grid">
    <section class="card">
      <h2 style="margin:0 0 10px 0;font-size:16px">Eingabe</h2>

      <div class="grid" style="grid-template-columns:1fr;gap:10px">
        <div>
          <label for="inFront">Vorderseite</label>
          <input id="inFront" type="text" />
        </div>
        <div>
          <label for="inBack">R√ºckseite</label>
          <input id="inBack" type="text" />
        </div>

        <div class="row">
          <span class="pill">Fach:</span>
          <div class="stars" id="newStars">
            <button class="dotBtn active" data-stars="0" type="button">0</button>
            <button class="dotBtn" data-stars="1" type="button">1</button>
            <button class="dotBtn" data-stars="2" type="button">2</button>
            <button class="dotBtn" data-stars="3" type="button">3</button>
            <button class="dotBtn" data-stars="4" type="button">4</button>
            <button class="dotBtn" data-stars="5" type="button">5</button>
            <button class="dotBtn red" data-stars="6" type="button">6</button>
            <button class="dotBtn red" data-stars="7" type="button">7</button>
          </div>

          <span class="pill">Startstatus:</span>
          <div class="row" style="gap:6px;flex-wrap:wrap">
            <button id="btnSetUnknownFront" type="button" class="active">‚ùå DE‚ÜíES</button>
            <button id="btnSetKnownFront" type="button">‚úÖ DE‚ÜíES</button>
            <button id="btnSetUnknownBack" type="button" class="active">‚ùå ES‚ÜíDE</button>
            <button id="btnSetKnownBack" type="button">‚úÖ ES‚ÜíDE</button>
          </div>
        </div>

        <div class="row">
          <button class="primary" id="btnAdd" type="button">Hinzuf√ºgen</button>
          <button id="btnAddStay" type="button">Hinzuf√ºgen & Felder leeren</button>
        </div>

        <div class="divider"></div>

        <details open>
          <summary>Listen-Eingabe (mehrere Zeilen)</summary>
          <p class="muted small" style="margin:8px 0 10px 0">
            Pro Zeile: <span class="mono">Vorderseite;R√ºckseite</span>. Optional:
            <span class="mono">;Fach(0-7);StatusDE(known/unknown);StatusES(known/unknown)</span>
          </p>
          <textarea id="bulkEntry"></textarea>

          <div class="row" style="align-items:flex-end">
            <div style="flex:1 1 260px;min-width:220px">
              <label>Wenn Fach/Status fehlen, nutze:</label>
              <div class="row" style="gap:8px">
                <select id="bulkDefaultStars" style="width:auto">
                  <option value="0">Fach 0</option>
                  <option value="1">Fach 1</option>
                  <option value="2">Fach 2</option>
                  <option value="3">Fach 3</option>
                  <option value="4">Fach 4</option>
                  <option value="5">Fach 5</option>
                  <option value="6">Fach 6 (6‚Üî7)</option>
                  <option value="7">Fach 7 (6‚Üî7)</option>
                </select>
                <select id="bulkDefaultStatusFront" style="width:auto">
                  <option value="unknown">DE‚ÜíES: nicht gewusst</option>
                  <option value="known">DE‚ÜíES: gewusst</option>
                </select>
                <select id="bulkDefaultStatusBack" style="width:auto">
                  <option value="unknown">ES‚ÜíDE: nicht gewusst</option>
                  <option value="known">ES‚ÜíDE: gewusst</option>
                </select>
              </div>
            </div>

            <div class="row" style="gap:8px">
              <button class="primary" id="btnBulkAdd" type="button">Liste hinzuf√ºgen</button>
              <button id="btnBulkClear" type="button">Liste leeren</button>
            </div>
          </div>

          <div class="muted small" id="bulkReport" style="margin-top:8px"></div>
        </details>
      </div>
    </section>

    <section class="card">
      <h2 style="margin:0 0 10px 0;font-size:16px">√úbersicht</h2>

      <div class="kpi" style="grid-template-columns:repeat(2,1fr)">
        <div class="box"><div class="muted">Karten</div><div class="num" id="kpiTotal">0</div></div>
        <div class="box"><div class="muted">Fach &gt; 0</div><div class="num" id="kpiFav">0</div></div>
      </div>

      <div class="divider"></div>
      <div class="muted small" style="margin-bottom:6px">F√§cher:</div>
      <div class="bins" id="starBins"></div>

      <div class="divider"></div>

      <div class="row" style="justify-content:space-between">
        <div style="flex:1 1 320px;min-width:220px">
          <label for="search">Suche</label>
          <input id="search" type="text" placeholder="Suche in Vorder- oder R√ºckseite‚Ä¶" />
        </div>
        <div style="flex:1 1 260px;min-width:220px">
          <label for="filter">Filter</label>
          <select id="filter">
            <option value="all">Alle</option>
            <option value="unknownFront">Nur ‚ùå DE‚ÜíES</option>
            <option value="unknownBack">Nur ‚ùå ES‚ÜíDE</option>
            <option value="unknownAny">Nur ‚ùå (irgendeine Richtung)</option>
            <option value="star0">Nur Fach 0</option>
            <option value="star1">Nur Fach 1</option>
            <option value="star2">Nur Fach 2</option>
            <option value="star3">Nur Fach 3</option>
            <option value="star4">Nur Fach 4</option>
            <option value="star5">Nur Fach 5</option>
            <option value="star6">Nur Fach 6 (6‚Üî7)</option>
            <option value="star7">Nur Fach 7 (6‚Üî7)</option>
          </select>
        </div>
      </div>

      <div class="divider"></div>
      <div class="list" id="cardList"></div>
      <div class="muted small" id="emptyHint" style="display:none">Noch keine Karten.</div>
    </section>
  </div>

  <!-- Learn -->
  <div id="viewLearn" style="display:none">
    <section class="card">
      <div class="flashWrap">

        <div class="flashTop">
          <div class="row" style="gap:10px">
            <span class="pill" id="progressPill">0 / 0</span>
            <span class="pill" id="modePill">Modus: ‚Äî</span>
            <span class="pill" id="dirPill">Richtung: ‚Äî</span>
          </div>
          <button id="btnBackToManage" class="ghost" type="button">‚¨ÖÔ∏è Zur√ºck zur Eingabe</button>
        </div>

        <!-- Konfiguration: sichtbar, solange NICHT im Player -->
        <div class="row" id="learnConfig" style="align-items:flex-end">
          <div style="flex:1 1 260px;min-width:220px">
            <label for="learnMode">Lernmodus</label>
            <select id="learnMode">
              <option value="all">Alle Karten</option>
              <option value="unknown">Nicht gewusst (abh√§ngig von Richtung)</option>
              <option value="star0">Fach 0</option>
              <option value="star1">Fach 1</option>
              <option value="star2">Fach 2</option>
              <option value="star3">Fach 3</option>
              <option value="star4">Fach 4</option>
              <option value="star5">Fach 5</option>
              <option value="star6">Fach 6 (6‚Üî7)</option>
              <option value="star7">Fach 7 (6‚Üî7)</option>
            </select>
          </div>

          <div style="flex:0 0 auto">
            <label for="direction">Richtung</label>
            <select id="direction">
              <option value="front">Vorderseite ‚Üí R√ºckseite (DE‚ÜíES)</option>
              <option value="back">R√ºckseite ‚Üí Vorderseite (ES‚ÜíDE)</option>
              <option value="mixed">Gemischt (beide Richtungen zuf√§llig)</option>
            </select>
          </div>

          <div style="flex:0 0 auto">
            <label for="order">Reihenfolge</label>
            <select id="order">
              <option value="random">Zuf√§llig</option>
              <option value="oldest">√Ñlteste zuerst</option>
              <option value="newest">Neueste zuerst</option>
            </select>
          </div>

          <button class="primary" id="btnStart" type="button">Start</button>
        </div>

        <div class="divider"></div>

        <div class="flashCard" id="flashCard" style="display:none" role="button" aria-label="Karte antippen f√ºr Antwort">
          <div class="flashPrompt" id="quizPrompt">‚Äî</div>
          <div class="flashAnswer" id="quizAnswer">‚Äî</div>
          <div class="tapHint">Tippe auf die Karte, um die Antwort ein-/auszublenden.</div>
        </div>

        <div class="learnBar" id="learnBar" style="display:none">
          <div class="flashControls" id="flashControls">
            <button id="btnKnown" type="button">‚úÖ Gewusst</button>
            <button id="btnUnknown" type="button">‚ùå Nicht gewusst</button>
            <button id="btnEditLearn" type="button">‚úèÔ∏è Bearbeiten</button>
            <button id="btnDelete" class="danger" type="button">üóëÔ∏è L√∂schen</button>
          </div>

          <div class="flashStars" id="flashStars">
            <span class="pill">Fach:</span>
            <button class="dotBtn" data-stars="0" type="button">0</button>
            <button class="dotBtn" data-stars="1" type="button">1</button>
            <button class="dotBtn" data-stars="2" type="button">2</button>
            <button class="dotBtn" data-stars="3" type="button">3</button>
            <button class="dotBtn" data-stars="4" type="button">4</button>
            <button class="dotBtn" data-stars="5" type="button">5</button>
            <button class="dotBtn red" data-stars="6" type="button">6</button>
            <button class="dotBtn red" data-stars="7" type="button">7</button>
            <span class="pill" id="statusHint">Status: ‚Äî</span>
          </div>
        </div>

        <div class="muted" id="learnHint">W√§hle Modus + Richtung und dr√ºcke ‚ÄûStart‚Äú.</div>
      </div>
    </section>
  </div>

  <!-- Data -->
  <div id="viewData" style="display:none">
    <section class="card">
      <div class="row" style="justify-content:space-between">
        <h2 style="margin:0;font-size:16px">Import / Export</h2>
        <button id="btnBackToManage2" class="ghost" type="button">‚¨ÖÔ∏è Zur√ºck zur Eingabe</button>
      </div>

      <div class="divider"></div>

      <h3 style="margin:0 0 8px 0;font-size:14px">Backup</h3>
      <p class="muted small" style="margin-top:0">Backup-Datei enth√§lt alle Daten.</p>
      <div class="fileRow">
        <button id="btnBackupJson" class="primary" type="button">Backup herunterladen (JSON)</button>
        <label class="pill" for="fileRestore">Backup wiederherstellen:</label>
        <input id="fileRestore" type="file" accept=".json,application/json" />
        <button id="btnRestoreJson" type="button">Wiederherstellen</button>
      </div>
      <div class="muted small" id="restoreReport" style="margin-top:8px"></div>

      <div class="divider"></div>

      <h3 style="margin:0 0 8px 0;font-size:14px">TXT Export</h3>
      <p class="muted small" style="margin-top:0">
        Format: <span class="mono">Vorderseite;R√ºckseite;Fach;StatusDE;StatusES</span>
      </p>
      <div class="row">
        <button id="btnExportTxtAll" type="button">TXT exportieren (alle)</button>
        <button id="btnExportTxtFav" type="button">TXT exportieren (nur Fach &gt; 0)</button>
        <button id="btnExportJson" type="button">JSON anzeigen (im Feld)</button>
      </div>
      <textarea id="exportOut" readonly placeholder="Export erscheint hier‚Ä¶"></textarea>

      <div class="divider"></div>

      <h3 style="margin:0 0 8px 0;font-size:14px;color:#b00020">Reset</h3>
      <p class="muted small" style="margin-top:0">L√∂scht alle Karten aus diesem Browser/Handy.</p>
      <button class="danger" id="btnReset" type="button">Alles l√∂schen</button>
    </section>
  </div>
</main>

<script>
(function(){
  window.addEventListener("error", (e) => {
    alert("Fehler im Script: " + (e && e.message ? e.message : "unbekannt"));
  });

  const PRIMARY_KEY = "vokabeltrainer_cards";
  const LEGACY_KEYS = [
    PRIMARY_KEY,
    "vokabeltrainer_v5_cards",
    "vokabeltrainer_v4_cards",
    "vokabeltrainer_v3_cards",
    "vokabeltrainer_v2_cards",
    "vokabeltrainer_cards_v1"
  ];

  let {cards, sourceKey} = loadWithMigration();
  cards = (cards||[]).map(ensureCardShape);

  function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
  function safeParse(raw){ try{ return JSON.parse(raw); }catch{ return null; } }

  function loadWithMigration(){
    for(const key of LEGACY_KEYS){
      const raw = localStorage.getItem(key);
      if(!raw) continue;
      const parsed = safeParse(raw);
      if(Array.isArray(parsed) && parsed.length){
        if(key !== PRIMARY_KEY){
          localStorage.setItem(PRIMARY_KEY, JSON.stringify(parsed));
        }
        return {cards: parsed, sourceKey: key};
      }
    }
    return {cards: [], sourceKey: "(leer)"};
  }

  function persistCardsOnly(){
    localStorage.setItem(PRIMARY_KEY, JSON.stringify(cards));
    sourceKey = PRIMARY_KEY;
  }
  function saveCards(){
    persistCardsOnly();
    refreshAll();
  }

  function normalizeStars(n){
    n = Number(n);
    if(Number.isNaN(n)) return 0;
    return Math.max(0, Math.min(7, Math.round(n)));
  }
  function normResult(s){ return (s==="known"||s==="unknown") ? s : "unknown"; }

  function ensureCardShape(c){
    const now = Date.now();
    const card = Object.assign({}, c);

    card.id = (typeof card.id==="string" && card.id) ? card.id : uid();
    card.front = (card.front||"").toString();
    card.back  = (card.back||"").toString();
    card.stars = normalizeStars(card.stars);

    const legacy = normResult(card.lastResult);
    if(!card.lastResultFront) card.lastResultFront = (card.lastResult ? legacy : "unknown");
    if(!card.lastResultBack)  card.lastResultBack  = (card.lastResult ? legacy : "unknown");

    card.lastResultFront = normResult(card.lastResultFront);
    card.lastResultBack  = normResult(card.lastResultBack);

    card.createdAt = Number.isFinite(card.createdAt) ? card.createdAt : now;
    card.updatedAt = Number.isFinite(card.updatedAt) ? card.updatedAt : now;

    return card;
  }

  function stripLeadingArticle(s){
    s = (s||"").toString().trim();
    s = s.replace(/^[‚Äû"'\(\[\{]+/g, "").trim();
    const articles = ["der","die","das","ein","eine","einen","einem","einer","eines","el","la","los","las","un","una","unos","unas","a","an","the"];
    const lower = s.toLowerCase();
    for(const art of articles){
      const prefix = art + " ";
      if(lower.startsWith(prefix)) return s.slice(prefix.length).trim();
    }
    return s;
  }

  function textIncludes(card, q){
    if(!q) return true;
    q = q.trim().toLowerCase();
    return (card.front||"").toLowerCase().includes(q) || (card.back||"").toLowerCase().includes(q);
  }

  function applyFilterManage(list, filter){
    switch(filter){
      case "unknownFront": return list.filter(c => c.lastResultFront === "unknown");
      case "unknownBack": return list.filter(c => c.lastResultBack === "unknown");
      case "unknownAny": return list.filter(c => c.lastResultFront === "unknown" || c.lastResultBack === "unknown");
      case "star0": return list.filter(c => normalizeStars(c.stars) === 0);
      case "star1": return list.filter(c => normalizeStars(c.stars) === 1);
      case "star2": return list.filter(c => normalizeStars(c.stars) === 2);
      case "star3": return list.filter(c => normalizeStars(c.stars) === 3);
      case "star4": return list.filter(c => normalizeStars(c.stars) === 4);
      case "star5": return list.filter(c => normalizeStars(c.stars) === 5);
      case "star6": return list.filter(c => normalizeStars(c.stars) === 6);
      case "star7": return list.filter(c => normalizeStars(c.stars) === 7);
      default: return list;
    }
  }

  function shuffle(arr){
    const a=[...arr];
    for(let i=a.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }
  function sortList(list, order){
    const a=[...list];
    if(order==="oldest") a.sort((x,y)=>(x.createdAt||0)-(y.createdAt||0));
    if(order==="newest") a.sort((x,y)=>(y.createdAt||0)-(x.createdAt||0));
    if(order==="random") return shuffle(a);
    return a;
  }

  const ui = {
    tab: "manage",
    newStars: 0,
    newFront: "unknown",
    newBack: "unknown",
    filter: "all",
    search: "",
    quizList: [],
    quizIndex: 0,
    currentCard: null,
    direction: "front",
    currentSide: "front",
    learnMode: "all",
    order: "random",
    revealed: false,
    isLearning: false
  };

  function setPlayerActive(active){
    ui.isLearning = active;

    const learn = document.getElementById("viewLearn");
    learn.classList.toggle("player", active);
    document.body.classList.toggle("playerActive", active);

    document.getElementById("learnConfig").style.display = active ? "none" : "";
    document.getElementById("learnHint").style.display = active ? "none" : "";
  }

  function setActiveTab(tab){
    ui.tab = tab;
    document.getElementById("tabManage").classList.toggle("active", tab==="manage");
    document.getElementById("tabLearn").classList.toggle("active", tab==="learn");
    document.getElementById("tabData").classList.toggle("active", tab==="data");
    document.getElementById("viewManage").style.display = tab==="manage" ? "" : "none";
    document.getElementById("viewLearn").style.display = tab==="learn" ? "" : "none";
    document.getElementById("viewData").style.display = tab==="data" ? "" : "none";

    // WICHTIG: Beim √ñffnen des Lern-Tabs NICHT automatisch Player!
    if(tab==="learn"){
      setPlayerActive(false);
      document.getElementById("flashCard").style.display="none";
      document.getElementById("learnBar").style.display="none";
      document.getElementById("learnHint").textContent = "W√§hle Modus + Richtung und dr√ºcke ‚ÄûStart‚Äú.";
      document.getElementById("progressPill").textContent = "0 / 0";
      document.getElementById("modePill").textContent = "Modus: ‚Äî";
      document.getElementById("dirPill").textContent = "Richtung: ‚Äî";
    }

    updateStatusLine();
  }

  function countsByStars(){
    const bins = {0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0};
    for(const c of cards) bins[normalizeStars(c.stars)]++;
    return bins;
  }

  function updateStatusLine(){
    const total = cards.length;
    document.getElementById("statusLine").textContent = `Karten: ${total}`;
    const bins = countsByStars();
    document.getElementById("binsTop").textContent =
      `F√§cher: 0=${bins[0]} ¬∑ 1=${bins[1]} ¬∑ 2=${bins[2]} ¬∑ 3=${bins[3]} ¬∑ 4=${bins[4]} ¬∑ 5=${bins[5]} ¬∑ 6=${bins[6]} ¬∑ 7=${bins[7]}`;
    document.getElementById("storageInfo").textContent =
      `Speicher: ${PRIMARY_KEY} (gefunden aus: ${sourceKey})`;
  }

  function renderKpis(){
    document.getElementById("kpiTotal").textContent = cards.length;
    document.getElementById("kpiFav").textContent = cards.filter(c=>normalizeStars(c.stars)>0).length;

    const bins = countsByStars();
    const starBins = document.getElementById("starBins");
    starBins.innerHTML = "";
    for(let n=0;n<=7;n++){
      const el = document.createElement("span");
      el.className = "bin" + ((n===6||n===7) ? " red" : "");
      el.textContent = `${n}: ${bins[n]}`;
      starBins.appendChild(el);
    }
  }

  function renderCardList(){
    const listEl = document.getElementById("cardList");
    const emptyHint = document.getElementById("emptyHint");
    listEl.innerHTML = "";

    let list = cards.map(ensureCardShape).filter(c => textIncludes(c, ui.search));
    list = applyFilterManage(list, ui.filter);

    if(list.length === 0){ emptyHint.style.display=""; return; }
    emptyHint.style.display="none";

    list.sort((a,b)=>{
      const A0 = stripLeadingArticle(a.front);
      const B0 = stripLeadingArticle(b.front);
      const c = A0.localeCompare(B0, "de", {sensitivity:"base"});
      if(c!==0) return c;
      const c2 = (a.front||"").trim().localeCompare((b.front||"").trim(), "de", {sensitivity:"base"});
      if(c2!==0) return c2;
      return (a.back||"").trim().localeCompare((b.back||"").trim(), "de", {sensitivity:"base"});
    });

    list.forEach(card=>{
      const item = document.createElement("div");
      item.className="item";

      const top = document.createElement("div");
      top.className="itemTop";

      const left = document.createElement("div");
      left.className="itemLeft";

      const front = document.createElement("div");
      front.className="front";
      front.textContent = card.front;

      const back = document.createElement("div");
      back.className="back";
      back.textContent = card.back;

      const meta = document.createElement("div");
      meta.className="row";
      meta.style.marginTop="8px";

      const pillDE = document.createElement("span");
      pillDE.className="pill";
      pillDE.textContent = `DE‚ÜíES: ${card.lastResultFront==="known" ? "gewusst ‚úÖ" : "nicht gewusst ‚ùå"}`;

      const pillES = document.createElement("span");
      pillES.className="pill";
      pillES.textContent = `ES‚ÜíDE: ${card.lastResultBack==="known" ? "gewusst ‚úÖ" : "nicht gewusst ‚ùå"}`;

      const pillStars = document.createElement("span");
      pillStars.className="pill";
      pillStars.textContent = `Fach: ${card.stars}` + ((card.stars===6||card.stars===7) ? " (6‚Üî7)" : "");

      meta.appendChild(pillDE); meta.appendChild(pillES); meta.appendChild(pillStars);
      left.appendChild(front); left.appendChild(back); left.appendChild(meta);

      const right = document.createElement("div");
      right.className="row";
      right.style.gap="6px";

      const starWrap = document.createElement("div");
      starWrap.className="stars";
      [0,1,2,3,4,5,6,7].forEach(n=>{
        const b=document.createElement("button");
        b.type="button";
        const isRed = (n===6 || n===7);
        b.className="dotBtn"+(isRed?" red":"")+(normalizeStars(card.stars)===n?" active":"");
        b.textContent = String(n);
        b.addEventListener("click", ()=>{
          card.stars=n; card.updatedAt=Date.now();
          const idx = cards.findIndex(x=>x.id===card.id);
          if(idx>=0) cards[idx] = ensureCardShape(Object.assign({}, cards[idx], card));
          saveCards();
        });
        starWrap.appendChild(b);
      });

      const btnEdit = document.createElement("button");
      btnEdit.type="button";
      btnEdit.textContent="‚úèÔ∏è";
      btnEdit.addEventListener("click", ()=>{
        const nf = prompt("Vorderseite:", card.front);
        if(nf===null) return;
        const nb = prompt("R√ºckseite:", card.back);
        if(nb===null) return;
        const idx = cards.findIndex(x=>x.id===card.id);
        if(idx>=0){
          cards[idx].front = nf.trim();
          cards[idx].back  = nb.trim();
          cards[idx].updatedAt = Date.now();
          saveCards();
        }
      });

      const btnDel = document.createElement("button");
      btnDel.type="button";
      btnDel.textContent="üóëÔ∏è";
      btnDel.className="danger";
      btnDel.addEventListener("click", ()=>{
        if(confirm("Diese Karte wirklich l√∂schen?")){
          cards = cards.filter(c=>c.id!==card.id);
          saveCards();
        }
      });

      right.appendChild(starWrap);
      right.appendChild(btnEdit);
      right.appendChild(btnDel);

      top.appendChild(left);
      top.appendChild(right);
      item.appendChild(top);
      listEl.appendChild(item);
    });
  }

  function setNewStars(n){
    ui.newStars = n;
    document.querySelectorAll("#newStars .dotBtn").forEach(btn=>{
      btn.classList.toggle("active", Number(btn.dataset.stars)===n);
    });
  }
  function setNewResultFront(res){
    ui.newFront = res;
    document.getElementById("btnSetUnknownFront").classList.toggle("active", res==="unknown");
    document.getElementById("btnSetKnownFront").classList.toggle("active", res==="known");
  }
  function setNewResultBack(res){
    ui.newBack = res;
    document.getElementById("btnSetUnknownBack").classList.toggle("active", res==="unknown");
    document.getElementById("btnSetKnownBack").classList.toggle("active", res==="known");
  }

  function addCard(stay){
    const front = document.getElementById("inFront").value.trim();
    const back  = document.getElementById("inBack").value.trim();
    if(!front || !back){ alert("Bitte Vorderseite UND R√ºckseite ausf√ºllen."); return; }
    const now = Date.now();
    cards.unshift(ensureCardShape({
      id: uid(), front, back,
      stars: ui.newStars,
      lastResultFront: ui.newFront,
      lastResultBack: ui.newBack,
      createdAt: now, updatedAt: now
    }));
    saveCards();
    if(stay){
      document.getElementById("inFront").value="";
      document.getElementById("inBack").value="";
      document.getElementById("inFront").focus();
    }
  }

  function bulkAdd(){
    const ta = document.getElementById("bulkEntry");
    const report = document.getElementById("bulkReport");
    const raw = ta.value;

    report.textContent = "";
    if(!raw.trim()){
      report.innerHTML = `<span class="warn">Keine Zeilen gefunden.</span>`;
      return;
    }

    const defaultStars = normalizeStars(document.getElementById("bulkDefaultStars").value);
    const defaultFront = normResult(document.getElementById("bulkDefaultStatusFront").value);
    const defaultBack  = normResult(document.getElementById("bulkDefaultStatusBack").value);

    const lines = raw.split(/\r?\n/);
    let added = 0, skipped = 0;
    const now = Date.now();

    for(const lineRaw of lines){
      const line = lineRaw.trim();
      if(!line) continue;

      const parts = line.split(";").map(p=>p.trim());
      if(parts.length < 2){ skipped++; continue; }

      const front = parts[0];
      const back  = parts[1];
      if(!front || !back){ skipped++; continue; }

      const stars = (parts.length>=3 && parts[2]!== "") ? normalizeStars(parts[2]) : defaultStars;
      const stFront = (parts.length>=4 && parts[3]!== "") ? normResult(parts[3].toLowerCase()) : defaultFront;
      const stBack  = (parts.length>=5 && parts[4]!== "") ? normResult(parts[4].toLowerCase()) : defaultBack;

      cards.unshift(ensureCardShape({
        id: uid(), front, back,
        stars,
        lastResultFront: stFront,
        lastResultBack: stBack,
        createdAt: now, updatedAt: now
      }));
      added++;
    }

    if(added===0){
      report.innerHTML = `<span class="warn">Nichts importiert.</span>`;
      return;
    }
    saveCards();
    report.innerHTML = `<span class="ok">Fertig:</span> ${added} hinzugef√ºgt` + (skipped ? ` ¬∑ <span class="warn">${skipped} √ºbersprungen</span>` : "");
  }

  function labelMode(m){
    if(m==="all") return "Alle";
    if(m==="unknown") return "Nicht gewusst";
    if(m==="star0") return "Fach 0";
    if(m==="star1") return "Fach 1";
    if(m==="star2") return "Fach 2";
    if(m==="star3") return "Fach 3";
    if(m==="star4") return "Fach 4";
    if(m==="star5") return "Fach 5";
    if(m==="star6") return "Fach 6 (6‚Üî7)";
    if(m==="star7") return "Fach 7 (6‚Üî7)";
    return "‚Äî";
  }
  function labelDir(d){
    if(d==="front") return "DE‚ÜíES";
    if(d==="back") return "ES‚ÜíDE";
    if(d==="mixed") return "Gemischt";
    return "‚Äî";
  }

  function passLearnMode(card){
    const m = ui.learnMode;
    if(m==="all") return true;

    if(m==="unknown"){
      if(ui.direction==="front") return card.lastResultFront==="unknown";
      if(ui.direction==="back")  return card.lastResultBack==="unknown";
      return (card.lastResultFront==="unknown" || card.lastResultBack==="unknown");
    }

    if(m==="star0") return normalizeStars(card.stars)===0;
    if(m==="star1") return normalizeStars(card.stars)===1;
    if(m==="star2") return normalizeStars(card.stars)===2;
    if(m==="star3") return normalizeStars(card.stars)===3;
    if(m==="star4") return normalizeStars(card.stars)===4;
    if(m==="star5") return normalizeStars(card.stars)===5;
    if(m==="star6") return normalizeStars(card.stars)===6;
    if(m==="star7") return normalizeStars(card.stars)===7;
    return true;
  }

  function updateLearnStatusHint(){
    if(!ui.currentCard) return;
    const dirLabel = (ui.currentSide==="front") ? "DE‚ÜíES" : "ES‚ÜíDE";
    const res = (ui.currentSide==="front") ? ui.currentCard.lastResultFront : ui.currentCard.lastResultBack;
    const special = (ui.currentCard.stars===6 || ui.currentCard.stars===7) ? " ¬∑ Sonderlogik 6‚Üî7" : "";
    document.getElementById("statusHint").textContent =
      `Status ${dirLabel}: ${res==="known" ? "gewusst ‚úÖ" : "nicht gewusst ‚ùå"} ¬∑ Fach: ${ui.currentCard.stars}${special}`;
  }

  function startQuiz(){
    ui.learnMode = document.getElementById("learnMode").value;
    ui.direction = document.getElementById("direction").value;
    ui.order = document.getElementById("order").value;

    let pool = cards.map(ensureCardShape).filter(passLearnMode);
    pool = sortList(pool, ui.order);

    const hint = document.getElementById("learnHint");
    const flashCard = document.getElementById("flashCard");
    const bar = document.getElementById("learnBar");

    if(pool.length===0){
      hint.innerHTML = `<span class="warn">Keine Karten gefunden.</span>`;
      flashCard.style.display = "none";
      bar.style.display="none";
      document.getElementById("progressPill").textContent = "0 / 0";
      document.getElementById("modePill").textContent = "Modus: ‚Äî";
      document.getElementById("dirPill").textContent = "Richtung: ‚Äî";
      setPlayerActive(false);
      return;
    }

    ui.quizList = pool.map(c=>c.id);
    ui.quizIndex = 0;
    ui.currentCard = null;
    ui.revealed = false;

    hint.textContent = "";
    flashCard.style.display="";
    bar.style.display="";

    document.getElementById("modePill").textContent = "Modus: " + labelMode(ui.learnMode);
    document.getElementById("dirPill").textContent = "Richtung: " + labelDir(ui.direction);

    // JETZT Player aktivieren
    setPlayerActive(true);
    showCurrent();
  }

  function showCurrent(){
    const id = ui.quizList[ui.quizIndex];
    const card = cards.find(c=>c.id===id);
    if(!card){ nextCard(); return; }

    ui.currentCard = ensureCardShape(card);

    let side = ui.direction;
    if(ui.direction === "mixed") side = Math.random() < 0.5 ? "front" : "back";
    ui.currentSide = side;

    const showFront = (side === "front");

    document.getElementById("progressPill").textContent = `${ui.quizIndex+1} / ${ui.quizList.length}`;
    document.getElementById("quizPrompt").textContent = showFront ? ui.currentCard.front : ui.currentCard.back;

    const ansEl = document.getElementById("quizAnswer");
    ansEl.textContent = showFront ? ui.currentCard.back : ui.currentCard.front;

    ui.revealed = false;
    ansEl.classList.remove("show");

    document.querySelectorAll("#flashStars .dotBtn").forEach(btn=>{
      const n = Number(btn.dataset.stars);
      btn.classList.toggle("active", n === normalizeStars(ui.currentCard.stars));
    });

    updateLearnStatusHint();
  }

  function toggleReveal(){
    if(!ui.currentCard) return;
    ui.revealed = !ui.revealed;
    document.getElementById("quizAnswer").classList.toggle("show", ui.revealed);
  }

  function nextCard(){
    if(ui.quizList.length===0) return;
    ui.quizIndex++;
    if(ui.quizIndex >= ui.quizList.length){
      document.getElementById("learnHint").textContent = "Fertig ‚úÖ";
      document.getElementById("flashCard").style.display="none";
      document.getElementById("learnBar").style.display="none";
      document.getElementById("progressPill").textContent = `${ui.quizList.length} / ${ui.quizList.length}`;

      // Nach Runde: Player aus (du landest wieder bei den Einstellungen)
      setPlayerActive(false);
      return;
    }
    showCurrent();
  }

  // Fach 0‚Äì5 normal: bekannt => runter (weniger √ºben), unbekannt => hoch (mehr √ºben)
  // Fach 6/7 separat: 6 <-> 7
  function markKnown(known){
    if(!ui.currentCard) return;

    const idx = cards.findIndex(c=>c.id===ui.currentCard.id);
    if(idx<0) return;

    const key = (ui.currentSide==="front") ? "lastResultFront" : "lastResultBack";
    cards[idx][key] = known ? "known" : "unknown";

    const cur = normalizeStars(cards[idx].stars);

    if(cur <= 5){
      const next = known ? Math.max(0, cur - 1) : Math.min(5, cur + 1);
      cards[idx].stars = next;
    } else if(cur === 6){
      if(!known) cards[idx].stars = 7; // 6 -> 7 bei nicht gewusst
    } else if(cur === 7){
      if(known) cards[idx].stars = 6;  // 7 -> 6 bei gewusst
    }

    cards[idx].updatedAt = Date.now();
    persistCardsOnly();

    updateStatusLine();
    renderKpis();
    renderCardList();

    nextCard();
  }

  function setStars(n){
    if(!ui.currentCard) return;
    const idx = cards.findIndex(c=>c.id===ui.currentCard.id);
    if(idx<0) return;

    cards[idx].stars = normalizeStars(n);
    cards[idx].updatedAt = Date.now();
    persistCardsOnly();

    document.querySelectorAll("#flashStars .dotBtn").forEach(btn=>{
      btn.classList.toggle("active", Number(btn.dataset.stars)===normalizeStars(n));
    });

    ui.currentCard = ensureCardShape(cards[idx]);
    updateLearnStatusHint();
    updateStatusLine();
    renderKpis();
    renderCardList();
  }

  function editCurrentInLearn(){
    if(!ui.currentCard) return;
    const idx = cards.findIndex(c=>c.id===ui.currentCard.id);
    if(idx<0) return;

    const nf = prompt("Vorderseite bearbeiten:", cards[idx].front);
    if(nf===null) return;
    const nb = prompt("R√ºckseite bearbeiten:", cards[idx].back);
    if(nb===null) return;

    cards[idx].front = nf.trim();
    cards[idx].back  = nb.trim();
    cards[idx].updatedAt = Date.now();
    saveCards();

    showCurrent();
  }

  function deleteCurrentFromLearn(){
    if(!ui.currentCard) return;
    if(!confirm("Diese Karte wirklich l√∂schen?")) return;

    const delId = ui.currentCard.id;
    cards = cards.filter(c => c.id !== delId);
    ui.quizList = ui.quizList.filter(id => id !== delId);
    saveCards();

    if(ui.quizList.length === 0){
      document.getElementById("learnHint").textContent = "Keine Karten mehr in dieser Runde.";
      document.getElementById("flashCard").style.display="none";
      document.getElementById("learnBar").style.display="none";
      document.getElementById("progressPill").textContent = "0 / 0";
      ui.currentCard = null;
      setPlayerActive(false);
      return;
    }
    if(ui.quizIndex >= ui.quizList.length) ui.quizIndex = ui.quizList.length - 1;
    showCurrent();
  }

  function downloadText(filename, text){
    const blob = new Blob([text], {type: "text/plain;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }
  function downloadJson(filename, obj){
    const text = JSON.stringify(obj, null, 2);
    const blob = new Blob([text], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }
  function sanitizeForTxt(s){ return String(s ?? "").replace(/\r?\n/g, " ").trim(); }
  function toAppTxtLines(list){
    return list.map(c => [
      sanitizeForTxt(c.front),
      sanitizeForTxt(c.back),
      String(normalizeStars(c.stars)),
      normResult(c.lastResultFront),
      normResult(c.lastResultBack)
    ].join(";"));
  }
  function makeFileName(base, ext){
    const d = new Date();
    const pad = (n)=>String(n).padStart(2,"0");
    const stamp = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}`;
    return `${base}_${stamp}.${ext}`;
  }
  function exportTxtAll(){
    const out = toAppTxtLines(cards.map(ensureCardShape)).join("\n");
    document.getElementById("exportOut").value = out;
    downloadText(makeFileName("vokabeln_alle", "txt"), out);
  }
  function exportTxtFav(){
    const fav = cards.map(ensureCardShape).filter(c => normalizeStars(c.stars) > 0);
    const out = toAppTxtLines(fav).join("\n");
    document.getElementById("exportOut").value = out;
    downloadText(makeFileName("vokabeln_favoriten", "txt"), out);
  }
  function exportJsonToField(){
    document.getElementById("exportOut").value = JSON.stringify(cards, null, 2);
  }
  function backupDownload(){
    const payload = { app:"vokabeltrainer", version:4, exportedAt:new Date().toISOString(), cards: cards.map(ensureCardShape) };
    downloadJson(makeFileName("vokabeltrainer_backup","json"), payload);
  }
  function restoreFromFile(){
    const input = document.getElementById("fileRestore");
    const report = document.getElementById("restoreReport");
    report.textContent = "";

    const file = input.files && input.files[0];
    if(!file){ report.innerHTML = `<span class="warn">Keine Datei ausgew√§hlt.</span>`; return; }

    const reader = new FileReader();
    reader.onload = () => {
      try{
        const parsed = JSON.parse(String(reader.result || ""));
        let incoming = null;
        if(Array.isArray(parsed)) incoming = parsed;
        else if(parsed && Array.isArray(parsed.cards)) incoming = parsed.cards;

        if(!Array.isArray(incoming)){
          report.innerHTML = `<span class="warn">Ung√ºltiges Backup-Format.</span>`;
          return;
        }

        const cleaned = [];
        for(const c of incoming){
          const front = (c && typeof c.front==="string") ? c.front.trim() : "";
          const back  = (c && typeof c.back==="string") ? c.back.trim() : "";
          if(!front || !back) continue;

          cleaned.push(ensureCardShape({
            id: (c && typeof c.id==="string" && c.id) ? c.id : uid(),
            front, back,
            stars: normalizeStars(c.stars),
            lastResultFront: normResult(c.lastResultFront || c.lastResult || "unknown"),
            lastResultBack:  normResult(c.lastResultBack  || c.lastResult || "unknown"),
            createdAt: (c && Number.isFinite(c.createdAt)) ? c.createdAt : Date.now(),
            updatedAt: (c && Number.isFinite(c.updatedAt)) ? c.updatedAt : Date.now(),
          }));
        }

        const seen = new Set();
        const unique = [];
        for(const c of cleaned){
          if(seen.has(c.id)) continue;
          seen.add(c.id);
          unique.push(c);
        }

        cards = unique;
        saveCards();
        report.innerHTML = `<span class="ok">Wiederhergestellt:</span> ${cards.length} Karten`;
      }catch(e){
        report.innerHTML = `<span class="warn">Fehler beim Einlesen:</span> ${String(e)}`;
      }finally{
        input.value = "";
      }
    };
    reader.readAsText(file);
  }
  function resetAll(){
    if(confirm("Wirklich ALLES l√∂schen? Das kann man nicht r√ºckg√§ngig machen.")){
      cards = [];
      for(const key of LEGACY_KEYS){
        try{ localStorage.removeItem(key); }catch{}
      }
      refreshAll();
      alert("Alles gel√∂scht.");
    }
  }

  function refreshAll(){
    updateStatusLine();
    renderKpis();
    renderCardList();
  }

  // UI Wireup
  document.getElementById("tabManage").addEventListener("click", ()=>{
    setPlayerActive(false);
    setActiveTab("manage");
  });
  document.getElementById("tabLearn").addEventListener("click", ()=>setActiveTab("learn"));
  document.getElementById("tabData").addEventListener("click", ()=>{
    setPlayerActive(false);
    setActiveTab("data");
  });

  // Zur√ºck zur Eingabe: beendet ggf. Player + geht auf Eingabe
  document.getElementById("btnBackToManage").addEventListener("click", ()=>{
    setPlayerActive(false);
    setActiveTab("manage");
  });
  document.getElementById("btnBackToManage2").addEventListener("click", ()=>{
    setPlayerActive(false);
    setActiveTab("manage");
  });

  document.getElementById("btnAdd").addEventListener("click", ()=>addCard(false));
  document.getElementById("btnAddStay").addEventListener("click", ()=>addCard(true));
  document.querySelectorAll("#newStars .dotBtn").forEach(btn=>{
    btn.addEventListener("click", ()=> setNewStars(Number(btn.dataset.stars)));
  });

  document.getElementById("btnSetUnknownFront").addEventListener("click", ()=> setNewResultFront("unknown"));
  document.getElementById("btnSetKnownFront").addEventListener("click", ()=> setNewResultFront("known"));
  document.getElementById("btnSetUnknownBack").addEventListener("click", ()=> setNewResultBack("unknown"));
  document.getElementById("btnSetKnownBack").addEventListener("click", ()=> setNewResultBack("known"));

  document.getElementById("btnBulkAdd").addEventListener("click", bulkAdd);
  document.getElementById("btnBulkClear").addEventListener("click", ()=>{
    document.getElementById("bulkEntry").value="";
    document.getElementById("bulkReport").textContent="";
  });

  document.getElementById("search").addEventListener("input", e=>{ ui.search=e.target.value; renderCardList(); });
  document.getElementById("filter").addEventListener("change", e=>{ ui.filter=e.target.value; renderCardList(); });

  document.getElementById("btnStart").addEventListener("click", startQuiz);
  document.getElementById("flashCard").addEventListener("click", toggleReveal);

  document.getElementById("btnKnown").addEventListener("click", ()=>markKnown(true));
  document.getElementById("btnUnknown").addEventListener("click", ()=>markKnown(false));
  document.getElementById("btnDelete").addEventListener("click", deleteCurrentFromLearn);
  document.getElementById("btnEditLearn").addEventListener("click", editCurrentInLearn);

  document.querySelectorAll("#flashStars .dotBtn").forEach(btn=>{
    btn.addEventListener("click", ()=> setStars(Number(btn.dataset.stars)));
  });

  document.getElementById("btnBackupJson").addEventListener("click", backupDownload);
  document.getElementById("btnRestoreJson").addEventListener("click", restoreFromFile);
  document.getElementById("btnExportTxtAll").addEventListener("click", exportTxtAll);
  document.getElementById("btnExportTxtFav").addEventListener("click", exportTxtFav);
  document.getElementById("btnExportJson").addEventListener("click", exportJsonToField);
  document.getElementById("btnReset").addEventListener("click", resetAll);

  document.getElementById("jsAlive").textContent = "JS: l√§uft ‚úÖ";
  setNewStars(0);
  setNewResultFront("unknown");
  setNewResultBack("unknown");
  document.getElementById("filter").value = "all";
  refreshAll();
})();
</script>
</body>
</html>
