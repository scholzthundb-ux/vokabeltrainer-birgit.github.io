      
<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vokabeltrainer (0‚Äì7 F√§cher ¬∑ Leitner+ ¬∑ Problemkarten ¬∑ Statistik ¬∑ Google-Drive-Backup)</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#f6f7fb;color:#111}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid #e7e7ef;z-index:50}
    .wrap{max-width:980px;margin:0 auto;padding:14px 16px}
    h1{font-size:18px;margin:0}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .tab{border:1px solid #d8d9e6;background:#fff;border-radius:10px;padding:8px 10px;font-weight:700;cursor:pointer}
    .tab.active{background:#111;color:#fff;border-color:#111}
    main{padding:16px}
    .grid{display:grid;gap:12px}
    @media (min-width:860px){ .grid{grid-template-columns: 1.3fr 1fr} }
    .card{background:#fff;border:1px solid #e7e7ef;border-radius:14px;padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{font-size:12px;font-weight:800;color:#333}
    input[type="text"], textarea, select{
      width:100%;box-sizing:border-box;border:1px solid #d8d9e6;border-radius:12px;
      padding:10px 12px;font-size:14px;background:#fff
    }
    textarea{min-height:110px;resize:vertical}
    button{
      border:1px solid #d8d9e6;background:#fff;border-radius:12px;
      padding:10px 12px;font-weight:800;cursor:pointer
    }
    button.primary{background:#111;color:#fff;border-color:#111}
    button.danger{background:#b00020;color:#fff;border-color:#b00020}
    button.ghost{background:transparent}
    .muted{color:#666;font-size:12px}
    .small{font-size:12px}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{border:1px solid #eee;border-radius:12px;padding:10px}
    .itemTop{display:flex;gap:8px;align-items:flex-start;justify-content:space-between}
    .itemLeft{min-width:0}
    .front{font-weight:900}
    .back{color:#333;margin-top:4px}
    .pill{font-size:12px;border:1px solid #ddd;border-radius:999px;padding:3px 8px;background:#fafafa}
    .stars{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
    .starBtn{padding:6px 10px;border-radius:999px}

    /* Kreise statt Sterne */
    .dotBtn{
      width:34px;height:34px;
      border-radius:999px;
      padding:0;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-weight:950;
      line-height:1;
    }
    .dotBtn.active{background:#111;color:#fff;border-color:#111}

    /* Sonderf√§cher 6/7 rot */
    .dotBtn.special{border-color:#b00020;color:#b00020}
    .dotBtn.special.active{background:#b00020;color:#fff;border-color:#b00020}

    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .kpi .box{border:1px solid #eee;border-radius:12px;padding:10px;background:#fff}
    .kpi .num{font-size:18px;font-weight:900}
    .divider{height:1px;background:#eee;margin:10px 0}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    details{border:1px solid #eee;border-radius:12px;padding:10px;background:#fff}
    summary{cursor:pointer;font-weight:900}
    .ok{color:#0a7a0a;font-weight:800}
    .warn{color:#b00020;font-weight:800}

    /* Fach-Anzeige */
    .bins{display:flex;gap:6px;flex-wrap:wrap}
    .bin{font-size:12px;border:1px solid #ddd;border-radius:999px;padding:4px 10px;background:#fafafa}
    .bin.special{border-color:#b00020;color:#b00020;background:#fff5f6}

    /* Lernkarte */
    .flashWrap{display:flex;flex-direction:column;gap:12px}
    .flashTop{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .flashCard{
      height: calc(100vh - 440px);
      min-height: 44vh;
      display:flex;flex-direction:column;justify-content:center;align-items:center;
      border:1px solid #e7e7ef;border-radius:18px;
      background:#f3eadb; /* hellbeige */
      padding:18px;text-align:center;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      cursor:pointer;
      position:relative;
      z-index:1;
    }
    @media (max-width:480px){
      .flashCard{ height: calc(100vh - 500px); min-height: 40vh; }
    }
    .flashPrompt{
      font-size:30px;font-weight:950;line-height:1.15;
      max-width:880px;word-break:break-word;
    }
    .flashAnswer{
      margin-top:16px;
      font-size:22px;line-height:1.25;
      max-width:880px;word-break:break-word;
      color:#222;
      display:none;
      background:rgba(255,255,255,0.65);border:1px dashed #d8d9e6;border-radius:14px;padding:14px;
      width:100%;
      box-sizing:border-box;
    }
    .flashAnswer.show{display:block}
    .tapHint{margin-top:10px;font-size:12px;color:#666}

    /* Controls immer √ºber der Karte, immer klickbar */
    .learnBar{
      position:sticky;
      bottom:10px;
      z-index:1000;
      background:rgba(246,247,251,0.96);
      backdrop-filter: blur(6px);
      border:1px solid #e7e7ef;
      border-radius:16px;
      padding:10px;
    }
    .flashControls{
      display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:center
    }
    .flashControls button{min-width:140px}
    .flashStars{display:flex;gap:6px;align-items:center;justify-content:center;flex-wrap:wrap;margin-top:8px}

    .fileRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input[type="file"]{max-width:100%}

    /* Vollbildmodus (nur Abfrage) */
    .learnFullscreen #viewLearn{
      position:fixed; inset:0;
      background:#f6f7fb;
      z-index:9999;
      overflow:auto;
      padding:14px 16px;
    }
    .learnFullscreen header{display:none}
    .learnFullscreen main.wrap{max-width:980px}
    .learnFullscreen .flashCard{
      height: calc(100vh - 270px);
      min-height: 55vh;
    }

    /* Charts */
    .chartWrap{display:grid;gap:12px}
    @media (min-width:860px){ .chartWrap{grid-template-columns: 1fr 1fr} }
    canvas{width:100%;height:240px;border:1px solid #eee;border-radius:12px;background:#fff}
    .statGrid{display:grid;gap:10px}
    @media (min-width:860px){ .statGrid{grid-template-columns: 1fr 1fr} }
    .rangeRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input[type="range"]{width:240px}
  </style>

  <!-- Google Identity Services (OAuth Token) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>

<body>
<header>
  <div class="wrap">
    <h1>Vokabeltrainer</h1>
    <div class="tabs">
      <button class="tab active" id="tabManage">Eingabe & Verwaltung</button>
      <button class="tab" id="tabLearn">Abfrage</button>
      <button class="tab" id="tabData">Import/Export</button>
      <button class="tab" id="tabStats">Statistik</button>
    </div>

    <div class="muted small" id="statusLine"></div>
    <div class="muted small" id="binsTop"></div>
    <div class="muted small" id="storageInfo"></div>
    <div class="muted small" id="driveTopInfo"></div>
    <div class="muted small" id="jsAlive">JS: ‚Ä¶</div>
  </div>
</header>

<main class="wrap">
  <!-- Manage -->
  <div id="viewManage" class="grid">
    <section class="card">
      <h2 style="margin:0 0 10px 0;font-size:16px">Eingabe</h2>

      <div class="grid" style="grid-template-columns:1fr;gap:10px">
        <div>
          <label for="inFront">Vorderseite</label>
          <input id="inFront" type="text" />
        </div>
        <div>
          <label for="inBack">R√ºckseite</label>
          <input id="inBack" type="text" />
        </div>

        <div class="row">
          <span class="pill">Fach:</span>
          <div class="stars" id="newStars">
            <button class="starBtn dotBtn active" data-stars="0" type="button">0</button>
            <button class="starBtn dotBtn" data-stars="1" type="button">1</button>
            <button class="starBtn dotBtn" data-stars="2" type="button">2</button>
            <button class="starBtn dotBtn" data-stars="3" type="button">3</button>
            <button class="starBtn dotBtn" data-stars="4" type="button">4</button>
            <button class="starBtn dotBtn" data-stars="5" type="button">5</button>
            <button class="starBtn dotBtn special" data-stars="6" type="button">6</button>
            <button class="starBtn dotBtn special" data-stars="7" type="button">7</button>
          </div>

          <span class="pill">Startstatus:</span>
          <div class="row" style="gap:6px;flex-wrap:wrap">
            <button id="btnSetUnknownFront" type="button" class="starBtn active">‚ùå DE‚ÜíES</button>
            <button id="btnSetKnownFront" type="button" class="starBtn">‚úÖ DE‚ÜíES</button>
            <button id="btnSetUnknownBack" type="button" class="starBtn active">‚ùå ES‚ÜíDE</button>
            <button id="btnSetKnownBack" type="button" class="starBtn">‚úÖ ES‚ÜíDE</button>
          </div>
        </div>

        <div class="row">
          <button class="primary" id="btnAdd" type="button">Hinzuf√ºgen</button>
          <button id="btnAddStay" type="button">Hinzuf√ºgen & Felder leeren</button>
        </div>

        <div class="divider"></div>

        <details open>
          <summary>Listen-Eingabe (mehrere Zeilen)</summary>
          <p class="muted small" style="margin:8px 0 10px 0">
            Pro Zeile: <span class="mono">Vorderseite;R√ºckseite</span>. Optional:
            <span class="mono">;Fach(0-7);StatusDE(known/unknown);StatusES(known/unknown)</span>
          </p>
          <textarea id="bulkEntry"></textarea>

          <div class="row" style="align-items:flex-end">
            <div style="flex:1 1 260px;min-width:220px">
              <label>Wenn Fach/Status fehlen, nutze:</label>
              <div class="row" style="gap:8px">
                <select id="bulkDefaultStars" style="width:auto">
                  <option value="0">Fach 0</option>
                  <option value="1">Fach 1</option>
                  <option value="2">Fach 2</option>
                  <option value="3">Fach 3</option>
                  <option value="4">Fach 4</option>
                  <option value="5">Fach 5</option>
                  <option value="6">Fach 6 (rot, manuell)</option>
                  <option value="7">Fach 7 (rot, manuell)</option>
                </select>
                <select id="bulkDefaultStatusFront" style="width:auto">
                  <option value="unknown">DE‚ÜíES: nicht gewusst</option>
                  <option value="known">DE‚ÜíES: gewusst</option>
                </select>
                <select id="bulkDefaultStatusBack" style="width:auto">
                  <option value="unknown">ES‚ÜíDE: nicht gewusst</option>
                  <option value="known">ES‚ÜíDE: gewusst</option>
                </select>
              </div>
            </div>

            <div class="row" style="gap:8px">
              <button class="primary" id="btnBulkAdd" type="button">Liste hinzuf√ºgen</button>
              <button id="btnBulkClear" type="button">Liste leeren</button>
            </div>
          </div>

          <div class="muted small" id="bulkReport" style="margin-top:8px"></div>
        </details>
      </div>
    </section>

    <section class="card">
      <h2 style="margin:0 0 10px 0;font-size:16px">√úbersicht</h2>

      <div class="kpi" style="grid-template-columns:repeat(3,1fr)">
        <div class="box"><div class="muted">Karten</div><div class="num" id="kpiTotal">0</div></div>
        <div class="box"><div class="muted">Fach &gt; 0</div><div class="num" id="kpiFav">0</div></div>
        <div class="box"><div class="muted">Problemkarten</div><div class="num" id="kpiProblems">0</div></div>
      </div>

      <div class="divider"></div>
      <div class="muted small" style="margin-bottom:6px">F√§cher:</div>
      <div class="bins" id="starBins"></div>

      <div class="divider"></div>

      <div class="row" style="justify-content:space-between">
        <div style="flex:1 1 320px;min-width:220px">
          <label for="search">Suche</label>
          <input id="search" type="text" placeholder="Suche in Vorder- oder R√ºckseite‚Ä¶" />
        </div>
        <div style="flex:1 1 260px;min-width:220px">
          <label for="filter">Filter</label>
          <select id="filter">
            <option value="all">Alle</option>
            <option value="unknownFront">Nur ‚ùå DE‚ÜíES</option>
            <option value="unknownBack">Nur ‚ùå ES‚ÜíDE</option>
            <option value="unknownAny">Nur ‚ùå (irgendeine Richtung)</option>
            <option value="problem">Nur Problemkarten</option>
            <option value="star0">Nur Fach 0</option>
            <option value="star1">Nur Fach 1</option>
            <option value="star2">Nur Fach 2</option>
            <option value="star3">Nur Fach 3</option>
            <option value="star4">Nur Fach 4</option>
            <option value="star5">Nur Fach 5</option>
            <option value="star6">Nur Fach 6 (rot)</option>
            <option value="star7">Nur Fach 7 (rot)</option>
          </select>
        </div>
      </div>

      <div class="divider"></div>
      <div class="list" id="cardList"></div>
      <div class="muted small" id="emptyHint" style="display:none">Noch keine Karten.</div>
    </section>
  </div>

  <!-- Learn -->
  <div id="viewLearn" style="display:none">
    <section class="card">
      <div class="flashWrap">
        <div class="flashTop">
          <div class="row" style="gap:10px">
            <span class="pill" id="progressPill">0 / 0</span>
            <span class="pill" id="modePill">Modus: ‚Äî</span>
            <span class="pill" id="dirPill">Richtung: ‚Äî</span>
          </div>
          <button id="btnBackToManage" class="ghost" type="button">‚¨ÖÔ∏è Zur√ºck zur Eingabe</button>
        </div>

        <div class="row" style="align-items:flex-end">
          <div style="flex:1 1 260px;min-width:220px">
            <label for="learnMode">Lernmodus</label>
            <select id="learnMode">
              <option value="all">Alle Karten</option>
              <option value="unknown">Nicht gewusst (abh√§ngig von Richtung)</option>
              <option value="problem">Problemkarten (Statistik-basiert)</option>
              <option value="star0">Fach 0</option>
              <option value="star1">Fach 1</option>
              <option value="star2">Fach 2</option>
              <option value="star3">Fach 3</option>
              <option value="star4">Fach 4</option>
              <option value="star5">Fach 5</option>
              <option value="star6">Fach 6 (rot, manuell)</option>
              <option value="star7">Fach 7 (rot, manuell)</option>
            </select>
          </div>

          <div id="problemControls" style="display:none;flex:1 1 260px;min-width:220px">
            <label>Problem-Schwelle (‚â§ Genauigkeit %)</label>
            <div class="rangeRow">
              <input id="problemThreshold" type="range" min="10" max="90" step="5" value="60" />
              <span class="pill" id="problemThresholdLabel">60%</span>
              <span class="muted small">min. 3 Versuche pro Richtung</span>
            </div>
          </div>

          <div style="flex:0 0 auto">
            <label for="direction">Richtung</label>
            <select id="direction">
              <option value="front">Vorderseite ‚Üí R√ºckseite (DE‚ÜíES)</option>
              <option value="back">R√ºckseite ‚Üí Vorderseite (ES‚ÜíDE)</option>
              <option value="mixed">Gemischt (beide Richtungen zuf√§llig)</option>
            </select>
          </div>

          <div style="flex:0 0 auto">
            <label for="order">Reihenfolge</label>
            <select id="order">
              <option value="random">Zuf√§llig</option>
              <option value="oldest">√Ñlteste zuerst</option>
              <option value="newest">Neueste zuerst</option>
            </select>
          </div>

          <button class="primary" id="btnStart" type="button">Start</button>
        </div>

        <div class="divider"></div>

        <div class="flashCard" id="flashCard" style="display:none" role="button" aria-label="Karte antippen f√ºr Antwort">
          <div class="flashPrompt" id="quizPrompt">‚Äî</div>
          <div class="flashAnswer" id="quizAnswer">‚Äî</div>
          <div class="tapHint">Tippe auf die Karte, um die Antwort ein-/auszublenden.</div>
        </div>

        <div class="learnBar" id="learnBar" style="display:none">
          <div class="flashControls" id="flashControls">
            <button id="btnKnown" type="button">‚úÖ Gewusst</button>
            <button id="btnUnknown" type="button">‚ùå Nicht gewusst</button>
            <button id="btnEditLearn" type="button">‚úèÔ∏è Bearbeiten</button>
            <button id="btnDelete" class="danger" type="button">üóëÔ∏è L√∂schen</button>
          </div>

          <div class="flashStars" id="flashStars">
            <span class="pill">Fach:</span>
            <button class="starBtn dotBtn tight" data-stars="0" type="button">0</button>
            <button class="starBtn dotBtn tight" data-stars="1" type="button">1</button>
            <button class="starBtn dotBtn tight" data-stars="2" type="button">2</button>
            <button class="starBtn dotBtn tight" data-stars="3" type="button">3</button>
            <button class="starBtn dotBtn tight" data-stars="4" type="button">4</button>
            <button class="starBtn dotBtn tight" data-stars="5" type="button">5</button>
            <button class="starBtn dotBtn tight special" data-stars="6" type="button">6</button>
            <button class="starBtn dotBtn tight special" data-stars="7" type="button">7</button>
            <span class="pill" id="statusHint">Status: ‚Äî</span>
          </div>
          <div class="muted small" id="specialHint" style="text-align:center;margin-top:6px;display:none">
            Hinweis: In Fach 6/7 rutschen Karten <b>nicht automatisch</b>. Nur manuell per Fach-Klick.
          </div>
        </div>

        <div class="muted" id="learnHint">W√§hle Modus + Richtung und dr√ºcke ‚ÄûStart‚Äú.</div>
      </div>
    </section>
  </div>

  <!-- Data -->
  <div id="viewData" style="display:none">
    <section class="card">
      <div class="row" style="justify-content:space-between">
        <h2 style="margin:0;font-size:16px">Import / Export</h2>
        <button id="btnBackToManage2" class="ghost" type="button">‚¨ÖÔ∏è Zur√ºck zur Eingabe</button>
      </div>

      <div class="divider"></div>

      <h3 style="margin:0 0 8px 0;font-size:14px">Backup</h3>
      <p class="muted small" style="margin-top:0">
        Backup-Datei enth√§lt alle Daten (inkl. Fach 0‚Äì7, Status pro Richtung, Statistik pro Karte).
      </p>
      <div class="fileRow">
        <button id="btnBackupJson" class="primary" type="button">Backup herunterladen (JSON)</button>
        <label class="pill" for="fileRestore">Backup wiederherstellen:</label>
        <input id="fileRestore" type="file" accept=".json,application/json" />
        <button id="btnRestoreJson" type="button">Wiederherstellen</button>
      </div>
      <div class="muted small" id="restoreReport" style="margin-top:8px"></div>

      <div class="divider"></div>

      <h3 style="margin:0 0 8px 0;font-size:14px">TXT Export</h3>
      <p class="muted small" style="margin-top:0">
        Format: <span class="mono">Vorderseite;R√ºckseite;Fach;StatusDE;StatusES</span>
        (Status = <span class="mono">known</span>/<span class="mono">unknown</span>)
      </p>
      <div class="row">
        <button id="btnExportTxtAll" type="button">TXT exportieren (alle)</button>
        <button id="btnExportTxtFav" type="button">TXT exportieren (nur Fach &gt; 0)</button>
        <button id="btnExportJson" type="button">JSON anzeigen (im Feld)</button>
      </div>
      <textarea id="exportOut" readonly placeholder="Export erscheint hier‚Ä¶"></textarea>

      <div class="divider"></div>

      <h3 style="margin:0 0 8px 0;font-size:14px">Google Drive Auto-Backup</h3>
      <p class="muted small" style="margin-top:0">
        Speichert ein verstecktes Backup in deinem Google Drive <span class="mono">appDataFolder</span>.
        <b>Wichtig:</b> Damit das klappt, musst du in der Google Cloud Console eine OAuth Client-ID + API-Key erstellen
        und unten eintragen (weil Google sonst keine Tokens ausstellt).
      </p>

      <details>
        <summary>Google-Drive Setup (einmalig)</summary>
        <ol class="small" style="margin:10px 0 0 18px">
          <li>Google Cloud Projekt erstellen, ‚ÄûGoogle Drive API‚Äú aktivieren.</li>
          <li>OAuth Client-ID f√ºr ‚ÄûWeb application‚Äú erstellen.</li>
          <li><b>Authorized JavaScript origins</b>: die URL, unter der diese HTML l√§uft (z. B. <span class="mono">https://deinname.github.io</span>).</li>
          <li>API-Key erstellen.</li>
          <li>Unten eintragen.</li>
        </ol>
      </details>

      <div class="row" style="margin-top:10px">
        <div style="flex:1 1 320px;min-width:220px">
          <label for="driveApiKey">Google API Key</label>
          <input id="driveApiKey" type="text" placeholder="AIza..." />
        </div>
        <div style="flex:1 1 320px;min-width:220px">
          <label for="driveClientId">Google OAuth Client ID</label>
          <input id="driveClientId" type="text" placeholder="1234567890-xxxx.apps.googleusercontent.com" />
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="btnDriveSaveConfig" type="button">Konfiguration speichern</button>
        <button id="btnDriveConnect" class="primary" type="button">Mit Google Drive verbinden</button>
        <button id="btnDriveDisconnect" type="button">Trennen</button>
        <button id="btnDriveBackupNow" type="button">Backup jetzt</button>
      </div>

      <div class="row" style="margin-top:10px">
        <label class="pill" style="display:flex;gap:8px;align-items:center">
          <input id="driveAutoToggle" type="checkbox" />
          Auto-Backup bei √Ñnderungen (max. alle 2 Min.)
        </label>
        <span class="muted small" id="driveStatus">Drive: nicht verbunden</span>
      </div>

      <div class="divider"></div>

      <h3 style="margin:0 0 8px 0;font-size:14px;color:#b00020">Reset</h3>
      <p class="muted small" style="margin-top:0">L√∂scht alle Karten aus diesem Browser/Handy.</p>
      <button class="danger" id="btnReset" type="button">Alles l√∂schen</button>
    </section>
  </div>

  <!-- Stats -->
  <div id="viewStats" style="display:none">
    <section class="card">
      <div class="row" style="justify-content:space-between">
        <h2 style="margin:0;font-size:16px">Statistik & Fortschritt</h2>
        <button id="btnBackToManage3" class="ghost" type="button">‚¨ÖÔ∏è Zur√ºck zur Eingabe</button>
      </div>

      <div class="divider"></div>

      <div class="statGrid">
        <div class="box" style="border:1px solid #eee;border-radius:12px;padding:10px;background:#fff">
          <div class="muted">Gesamtversuche</div>
          <div class="num" id="statTotalAttempts">0</div>
          <div class="muted small" id="statTotalAttemptsSub"></div>
        </div>

        <div class="box" style="border:1px solid #eee;border-radius:12px;padding:10px;background:#fff">
          <div class="muted">Gesamtgenauigkeit</div>
          <div class="num" id="statAccuracy">0%</div>
          <div class="muted small" id="statAccuracySub"></div>
        </div>

        <div class="box" style="border:1px solid #eee;border-radius:12px;padding:10px;background:#fff">
          <div class="muted">Problemkarten</div>
          <div class="num" id="statProblemCount">0</div>
          <div class="muted small">Karten mit niedriger Trefferquote (min. 3 Versuche pro Richtung)</div>
        </div>

        <div class="box" style="border:1px solid #eee;border-radius:12px;padding:10px;background:#fff">
          <div class="muted">Letztes Lernen</div>
          <div class="num" id="statLastLearn">‚Äî</div>
          <div class="muted small" id="statLastLearnSub"></div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="chartWrap">
        <div>
          <div class="row" style="justify-content:space-between;margin-bottom:6px">
            <div class="muted small">F√§cherverteilung (0‚Äì7)</div>
            <button id="btnRedrawCharts1" type="button">Neu zeichnen</button>
          </div>
          <canvas id="chartBins" width="900" height="240"></canvas>
        </div>
        <div>
          <div class="row" style="justify-content:space-between;margin-bottom:6px">
            <div class="muted small">Genauigkeit √ºber Zeit (letzte 100 Antworten)</div>
            <button id="btnClearStats" class="danger" type="button">Statistik zur√ºcksetzen</button>
          </div>
          <canvas id="chartAccuracy" width="900" height="240"></canvas>
        </div>
      </div>

      <div class="divider"></div>

      <details>
        <summary>Top Problemkarten anzeigen</summary>
        <div class="muted small" style="margin-top:6px">
          Sortiert nach schlechtester Trefferquote (min. 3 Versuche je Richtung, je nach gew√§hlter Richtung).
        </div>
        <div class="row" style="margin-top:10px">
          <label class="pill">Richtung:</label>
          <select id="statProblemDir" style="width:auto">
            <option value="front">DE‚ÜíES</option>
            <option value="back">ES‚ÜíDE</option>
            <option value="mixed">Gemischt</option>
          </select>
          <label class="pill">Max. Genauigkeit:</label>
          <select id="statProblemMaxAcc" style="width:auto">
            <option value="40">‚â§ 40%</option>
            <option value="50">‚â§ 50%</option>
            <option value="60" selected>‚â§ 60%</option>
            <option value="70">‚â§ 70%</option>
            <option value="80">‚â§ 80%</option>
          </select>
          <button id="btnShowProblems" type="button">Anzeigen</button>
        </div>
        <div class="list" id="problemList" style="margin-top:10px"></div>
      </details>

    </section>
  </div>
</main>

<script>
(function(){
  window.addEventListener("error", (e) => {
    alert("Fehler im Script: " + (e && e.message ? e.message : "unbekannt"));
  });

  /******************************************************************
   * 1) Speicher-Keys
   ******************************************************************/
  const PRIMARY_KEY = "vokabeltrainer_cards";
  const LEGACY_KEYS = [
    PRIMARY_KEY,
    "vokabeltrainer_v5_cards",
    "vokabeltrainer_v4_cards",
    "vokabeltrainer_v3_cards",
    "vokabeltrainer_v2_cards",
    "vokabeltrainer_cards_v1"
  ];

  const STATS_KEY = "vokabeltrainer_stats_v1";
  const DRIVE_CFG_KEY = "vokabeltrainer_drive_cfg_v1";
  const DRIVE_AUTO_KEY = "vokabeltrainer_drive_auto_v1";
  const DRIVE_FILE_NAME = "vokabeltrainer_autobackup.json";

  /******************************************************************
   * 2) Daten laden + Migration
   ******************************************************************/
  let {cards, sourceKey} = loadWithMigration();
  cards = (cards||[]).map(ensureCardShape);

  let stats = loadStats();
  let driveCfg = loadDriveCfg();
  let drive = createDriveState();

  function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
  function safeParse(raw){ try{ return JSON.parse(raw); }catch{ return null; } }

  function loadWithMigration(){
    for(const key of LEGACY_KEYS){
      const raw = localStorage.getItem(key);
      if(!raw) continue;
      const parsed = safeParse(raw);
      if(Array.isArray(parsed) && parsed.length){
        if(key !== PRIMARY_KEY){
          localStorage.setItem(PRIMARY_KEY, JSON.stringify(parsed));
        }
        return {cards: parsed, sourceKey: key};
      }
    }
    return {cards: [], sourceKey: "(leer)"};
  }

  function persistCardsOnly(){
    localStorage.setItem(PRIMARY_KEY, JSON.stringify(cards));
    sourceKey = PRIMARY_KEY;
    scheduleAutoDriveBackup("cards");
  }
  function saveCards(){
    persistCardsOnly();
    refreshAll();
  }

  /******************************************************************
   * 3) Stats (pro Karte + global)
   ******************************************************************/
  function nowIso(){ return new Date().toISOString(); }
  function loadStats(){
    const raw = localStorage.getItem(STATS_KEY);
    const parsed = safeParse(raw);
    const base = {
      version: 1,
      createdAt: nowIso(),
      lastLearnAt: null,
      totalAttempts: 0,
      totalCorrect: 0,
      // Timeline: pro Antwort ein Punkt (max 100)
      recent: [] // [{ts, correct}]
    };
    if(!parsed || typeof parsed !== "object") return base;
    return Object.assign(base, parsed, {
      recent: Array.isArray(parsed.recent) ? parsed.recent.slice(-200) : base.recent
    });
  }
  function persistStats(){
    try{
      localStorage.setItem(STATS_KEY, JSON.stringify(stats));
    }catch{}
  }
  function resetStats(){
    stats = loadStats();
    stats.createdAt = nowIso();
    stats.lastLearnAt = null;
    stats.totalAttempts = 0;
    stats.totalCorrect = 0;
    stats.recent = [];
    persistStats();
    refreshAll();
  }

  /******************************************************************
   * 4) Card shape
   ******************************************************************/
  function normalizeStars(n){
    n = Number(n);
    if(Number.isNaN(n)) return 0;
    return Math.max(0, Math.min(7, Math.round(n)));
  }
  function normResult(s){ return (s==="known"||s==="unknown") ? s : "unknown"; }

  function ensureCardShape(c){
    const now = Date.now();
    const card = Object.assign({}, c);

    card.id = (typeof card.id==="string" && card.id) ? card.id : uid();
    card.front = (card.front||"").toString();
    card.back  = (card.back||"").toString();
    card.stars = normalizeStars(card.stars);

    const legacy = normResult(card.lastResult);
    if(!card.lastResultFront) card.lastResultFront = (card.lastResult ? legacy : "unknown");
    if(!card.lastResultBack)  card.lastResultBack  = (card.lastResult ? legacy : "unknown");

    card.lastResultFront = normResult(card.lastResultFront);
    card.lastResultBack  = normResult(card.lastResultBack);

    // Statistik pro Richtung
    card.attemptsFront = Number.isFinite(card.attemptsFront) ? card.attemptsFront : 0;
    card.correctFront  = Number.isFinite(card.correctFront)  ? card.correctFront  : 0;
    card.attemptsBack  = Number.isFinite(card.attemptsBack)  ? card.attemptsBack  : 0;
    card.correctBack   = Number.isFinite(card.correctBack)   ? card.correctBack   : 0;

    card.lastSeenAt = Number.isFinite(card.lastSeenAt) ? card.lastSeenAt : 0;

    card.createdAt = Number.isFinite(card.createdAt) ? card.createdAt : now;
    card.updatedAt = Number.isFinite(card.updatedAt) ? card.updatedAt : now;

    return card;
  }

  function accuracyFor(card, side){
    const a = side==="front" ? card.attemptsFront : card.attemptsBack;
    const c = side==="front" ? card.correctFront  : card.correctBack;
    if(!a) return null;
    return Math.round((c/a)*100);
  }

  function isProblemCard(card, sideOrMixed, maxAcc, minAttempts=3){
    const c = ensureCardShape(card);
    const max = Number(maxAcc);
    if(sideOrMixed==="mixed"){
      const aF = c.attemptsFront, aB = c.attemptsBack;
      const okF = aF>=minAttempts ? (c.correctFront/aF)*100 : null;
      const okB = aB>=minAttempts ? (c.correctBack/aB)*100 : null;
      if(okF===null && okB===null) return false;
      const worst = Math.min(okF??100, okB??100);
      return worst <= max;
    }else{
      const a = sideOrMixed==="front" ? c.attemptsFront : c.attemptsBack;
      const ok = sideOrMixed==="front" ? (c.correctFront/a)*100 : (c.correctBack/a)*100;
      if(a < minAttempts) return false;
      return ok <= max;
    }
  }

  /******************************************************************
   * 5) Sort/Filter helpers
   ******************************************************************/
  function stripLeadingArticle(s){
    s = (s||"").toString().trim();
    s = s.replace(/^[‚Äû"'\(\[\{]+/g, "").trim();

    const articles = [
      "der","die","das","ein","eine","einen","einem","einer","eines",
      "el","la","los","las","un","una","unos","unas",
      "a","an","the"
    ];

    const lower = s.toLowerCase();
    for(const art of articles){
      const prefix = art + " ";
      if(lower.startsWith(prefix)){
        return s.slice(prefix.length).trim();
      }
    }
    return s;
  }

  function textIncludes(card, q){
    if(!q) return true;
    q = q.trim().toLowerCase();
    return (card.front||"").toLowerCase().includes(q) || (card.back||"").toLowerCase().includes(q);
  }

  function applyFilterManage(list, filter){
    switch(filter){
      case "unknownFront": return list.filter(c => c.lastResultFront === "unknown");
      case "unknownBack": return list.filter(c => c.lastResultBack === "unknown");
      case "unknownAny": return list.filter(c => c.lastResultFront === "unknown" || c.lastResultBack === "unknown");
      case "problem": return list.filter(c => isProblemCard(c, "mixed", 60, 3));
      case "star0": return list.filter(c => normalizeStars(c.stars) === 0);
      case "star1": return list.filter(c => normalizeStars(c.stars) === 1);
      case "star2": return list.filter(c => normalizeStars(c.stars) === 2);
      case "star3": return list.filter(c => normalizeStars(c.stars) === 3);
      case "star4": return list.filter(c => normalizeStars(c.stars) === 4);
      case "star5": return list.filter(c => normalizeStars(c.stars) === 5);
      case "star6": return list.filter(c => normalizeStars(c.stars) === 6);
      case "star7": return list.filter(c => normalizeStars(c.stars) === 7);
      default: return list;
    }
  }

  function shuffle(arr){
    const a=[...arr];
    for(let i=a.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }
  function sortList(list, order){
    const a=[...list];
    if(order==="oldest") a.sort((x,y)=>(x.createdAt||0)-(y.createdAt||0));
    if(order==="newest") a.sort((x,y)=>(y.createdAt||0)-(x.createdAt||0));
    if(order==="random") return shuffle(a);
    return a;
  }

  /******************************************************************
   * 6) UI State
   ******************************************************************/
  const ui = {
    tab: "manage",
    newStars: 0,
    newFront: "unknown",
    newBack: "unknown",
    filter: "all",
    search: "",
    quizList: [],
    quizIndex: 0,
    currentCard: null,
    direction: "front",
    currentSide: "front",
    learnMode: "all",
    order: "random",
    revealed: false,
    problemThreshold: 60
  };

  function setActiveTab(tab){
    ui.tab = tab;
    document.getElementById("tabManage").classList.toggle("active", tab==="manage");
    document.getElementById("tabLearn").classList.toggle("active", tab==="learn");
    document.getElementById("tabData").classList.toggle("active", tab==="data");
    document.getElementById("tabStats").classList.toggle("active", tab==="stats");

    document.getElementById("viewManage").style.display = tab==="manage" ? "" : "none";
    document.getElementById("viewLearn").style.display = tab==="learn" ? "" : "none";
    document.getElementById("viewData").style.display = tab==="data" ? "" : "none";
    document.getElementById("viewStats").style.display = tab==="stats" ? "" : "none";

    if(tab !== "learn"){
      document.body.classList.remove("learnFullscreen");
    }
    updateStatusLine();
    if(tab==="stats"){
      renderStats();
      drawCharts();
    }
  }

  function countsByStars(){
    const bins = {0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0};
    for(const c of cards){
      bins[normalizeStars(c.stars)]++;
    }
    return bins;
  }

  function updateStatusLine(){
    const total = cards.length;
    document.getElementById("statusLine").textContent = `Karten: ${total}`;
    const bins = countsByStars();
    document.getElementById("binsTop").textContent =
      `F√§cher: 0=${bins[0]} ¬∑ 1=${bins[1]} ¬∑ 2=${bins[2]} ¬∑ 3=${bins[3]} ¬∑ 4=${bins[4]} ¬∑ 5=${bins[5]} ¬∑ 6=${bins[6]} ¬∑ 7=${bins[7]}`;
    document.getElementById("storageInfo").textContent =
      `Speicher: ${PRIMARY_KEY} (gefunden aus: ${sourceKey})`;
    document.getElementById("driveTopInfo").textContent =
      drive.connected ? `Drive: verbunden ¬∑ Auto: ${drive.autoEnabled ? "an" : "aus"} ¬∑ Datei: ${DRIVE_FILE_NAME}` : `Drive: nicht verbunden`;
  }

  /******************************************************************
   * 7) Manage render
   ******************************************************************/
  function renderKpis(){
    document.getElementById("kpiTotal").textContent = cards.length;
    document.getElementById("kpiFav").textContent = cards.filter(c=>normalizeStars(c.stars)>0).length;
    document.getElementById("kpiProblems").textContent = cards.filter(c=>isProblemCard(c,"mixed",60,3)).length;

    const bins = countsByStars();
    const starBins = document.getElementById("starBins");
    starBins.innerHTML = "";
    for(let n=0;n<=7;n++){
      const el = document.createElement("span");
      el.className = "bin" + ((n===6||n===7) ? " special" : "");
      el.textContent = `${n}: ${bins[n]}` + ((n===6||n===7) ? " (manuell)" : "");
      starBins.appendChild(el);
    }
  }

  function renderCardList(){
    const listEl = document.getElementById("cardList");
    const emptyHint = document.getElementById("emptyHint");
    listEl.innerHTML = "";

    let list = cards.map(ensureCardShape).filter(c => textIncludes(c, ui.search));
    list = applyFilterManage(list, ui.filter);

    if(list.length === 0){ emptyHint.style.display=""; return; }
    emptyHint.style.display="none";

    list.sort((a,b)=>{
      const A0 = stripLeadingArticle(a.front);
      const B0 = stripLeadingArticle(b.front);
      const c = A0.localeCompare(B0, "de", {sensitivity:"base"});
      if(c!==0) return c;
      const c2 = (a.front||"").trim().localeCompare((b.front||"").trim(), "de", {sensitivity:"base"});
      if(c2!==0) return c2;
      return (a.back||"").trim().localeCompare((b.back||"").trim(), "de", {sensitivity:"base"});
    });

    list.forEach(card=>{
      const item = document.createElement("div");
      item.className="item";

      const top = document.createElement("div");
      top.className="itemTop";

      const left = document.createElement("div");
      left.className="itemLeft";

      const front = document.createElement("div");
      front.className="front";
      front.textContent = card.front;

      const back = document.createElement("div");
      back.className="back";
      back.textContent = card.back;

      const meta = document.createElement("div");
      meta.className="row";
      meta.style.marginTop="8px";

      const pillDE = document.createElement("span");
      pillDE.className="pill";
      pillDE.textContent = `DE‚ÜíES: ${card.lastResultFront==="known" ? "gewusst ‚úÖ" : "nicht gewusst ‚ùå"} ¬∑ ${fmtAcc(card,"front")}`;

      const pillES = document.createElement("span");
      pillES.className="pill";
      pillES.textContent = `ES‚ÜíDE: ${card.lastResultBack==="known" ? "gewusst ‚úÖ" : "nicht gewusst ‚ùå"} ¬∑ ${fmtAcc(card,"back")}`;

      const pillStars = document.createElement("span");
      pillStars.className="pill";
      pillStars.textContent = `Fach: ${card.stars}` + ((card.stars===6||card.stars===7) ? " (manuell)" : "");

      meta.appendChild(pillDE); meta.appendChild(pillES); meta.appendChild(pillStars);
      left.appendChild(front); left.appendChild(back); left.appendChild(meta);

      const right = document.createElement("div");
      right.className="row";
      right.style.gap="6px";

      const starWrap = document.createElement("div");
      starWrap.className="stars";
      [0,1,2,3,4,5,6,7].forEach(n=>{
        const b=document.createElement("button");
        b.type="button";
        const isSpecial = (n===6||n===7);
        b.className="starBtn dotBtn"+(isSpecial?" special":"")+(normalizeStars(card.stars)===n?" active":"");
        b.textContent = String(n);
        b.addEventListener("click", ()=>{
          card.stars=n; card.updatedAt=Date.now();
          const idx = cards.findIndex(x=>x.id===card.id);
          if(idx>=0) cards[idx] = ensureCardShape(Object.assign({}, cards[idx], card));
          saveCards();
        });
        starWrap.appendChild(b);
      });

      const btnKnownFront = document.createElement("button");
      btnKnownFront.type="button";
      btnKnownFront.textContent="‚úÖ DE‚ÜíES";
      btnKnownFront.addEventListener("click", ()=>{
        const idx = cards.findIndex(x=>x.id===card.id);
        if(idx>=0){
          cards[idx].lastResultFront="known";
          cards[idx].updatedAt=Date.now();
          saveCards();
        }
      });

      const btnUnknownFront = document.createElement("button");
      btnUnknownFront.type="button";
      btnUnknownFront.textContent="‚ùå DE‚ÜíES";
      btnUnknownFront.addEventListener("click", ()=>{
        const idx = cards.findIndex(x=>x.id===card.id);
        if(idx>=0){
          cards[idx].lastResultFront="unknown";
          cards[idx].updatedAt=Date.now();
          saveCards();
        }
      });

      const btnKnownBack = document.createElement("button");
      btnKnownBack.type="button";
      btnKnownBack.textContent="‚úÖ ES‚ÜíDE";
      btnKnownBack.addEventListener("click", ()=>{
        const idx = cards.findIndex(x=>x.id===card.id);
        if(idx>=0){
          cards[idx].lastResultBack="known";
          cards[idx].updatedAt=Date.now();
          saveCards();
        }
      });

      const btnUnknownBack = document.createElement("button");
      btnUnknownBack.type="button";
      btnUnknownBack.textContent="‚ùå ES‚ÜíDE";
      btnUnknownBack.addEventListener("click", ()=>{
        const idx = cards.findIndex(x=>x.id===card.id);
        if(idx>=0){
          cards[idx].lastResultBack="unknown";
          cards[idx].updatedAt=Date.now();
          saveCards();
        }
      });

      const btnEdit = document.createElement("button");
      btnEdit.type="button";
      btnEdit.textContent="‚úèÔ∏è";
      btnEdit.addEventListener("click", ()=>{
        const nf = prompt("Vorderseite:", card.front);
        if(nf===null) return;
        const nb = prompt("R√ºckseite:", card.back);
        if(nb===null) return;

        const idx = cards.findIndex(x=>x.id===card.id);
        if(idx>=0){
          cards[idx].front = nf.trim();
          cards[idx].back  = nb.trim();
          cards[idx].updatedAt = Date.now();
          saveCards();
        }
      });

      const btnDel = document.createElement("button");
      btnDel.type="button";
      btnDel.textContent="üóëÔ∏è";
      btnDel.className="danger";
      btnDel.addEventListener("click", ()=>{
        if(confirm("Diese Karte wirklich l√∂schen?")){
          cards = cards.filter(c=>c.id!==card.id);
          saveCards();
        }
      });

      right.appendChild(starWrap);
      right.appendChild(btnKnownFront);
      right.appendChild(btnUnknownFront);
      right.appendChild(btnKnownBack);
      right.appendChild(btnUnknownBack);
      right.appendChild(btnEdit);
      right.appendChild(btnDel);

      top.appendChild(left);
      top.appendChild(right);
      item.appendChild(top);
      listEl.appendChild(item);
    });
  }

  function fmtAcc(card, side){
    const c = ensureCardShape(card);
    const a = side==="front" ? c.attemptsFront : c.attemptsBack;
    const acc = accuracyFor(c, side);
    if(acc===null) return "‚Äî";
    return `${acc}% (${a}√ó)`;
  }

  /******************************************************************
   * 8) New-card defaults
   ******************************************************************/
  function setNewStars(n){
    ui.newStars = n;
    document.querySelectorAll("#newStars .starBtn").forEach(btn=>{
      btn.classList.toggle("active", Number(btn.dataset.stars)===n);
    });
  }
  function setNewResultFront(res){
    ui.newFront = res;
    document.getElementById("btnSetUnknownFront").classList.toggle("active", res==="unknown");
    document.getElementById("btnSetKnownFront").classList.toggle("active", res==="known");
  }
  function setNewResultBack(res){
    ui.newBack = res;
    document.getElementById("btnSetUnknownBack").classList.toggle("active", res==="unknown");
    document.getElementById("btnSetKnownBack").classList.toggle("active", res==="known");
  }

  function addCard(stay){
    const front = document.getElementById("inFront").value.trim();
    const back  = document.getElementById("inBack").value.trim();
    if(!front || !back){ alert("Bitte Vorderseite UND R√ºckseite ausf√ºllen."); return; }
    const now = Date.now();
    cards.unshift(ensureCardShape({
      id: uid(), front, back,
      stars: ui.newStars,
      lastResultFront: ui.newFront,
      lastResultBack: ui.newBack,
      attemptsFront: 0, correctFront: 0,
      attemptsBack: 0, correctBack: 0,
      createdAt: now, updatedAt: now
    }));
    saveCards();
    if(stay){
      document.getElementById("inFront").value="";
      document.getElementById("inBack").value="";
      document.getElementById("inFront").focus();
    }
  }

  function bulkAdd(){
    const ta = document.getElementById("bulkEntry");
    const report = document.getElementById("bulkReport");
    const raw = ta.value;

    report.textContent = "";
    if(!raw.trim()){
      report.innerHTML = `<span class="warn">Keine Zeilen gefunden.</span>`;
      return;
    }

    const defaultStars = normalizeStars(document.getElementById("bulkDefaultStars").value);
    const defaultFront = normResult(document.getElementById("bulkDefaultStatusFront").value);
    const defaultBack  = normResult(document.getElementById("bulkDefaultStatusBack").value);

    const lines = raw.split(/\r?\n/);
    let added = 0, skipped = 0;
    const now = Date.now();

    for(const lineRaw of lines){
      const line = lineRaw.trim();
      if(!line) continue;

      const parts = line.split(";").map(p=>p.trim());
      if(parts.length < 2){ skipped++; continue; }

      const front = parts[0];
      const back  = parts[1];
      if(!front || !back){ skipped++; continue; }

      const stars = (parts.length>=3 && parts[2]!== "") ? normalizeStars(parts[2]) : defaultStars;
      const stFront = (parts.length>=4 && parts[3]!== "") ? normResult(parts[3].toLowerCase()) : defaultFront;
      const stBack  = (parts.length>=5 && parts[4]!== "") ? normResult(parts[4].toLowerCase()) : defaultBack;

      cards.unshift(ensureCardShape({
        id: uid(), front, back,
        stars,
        lastResultFront: stFront,
        lastResultBack: stBack,
        attemptsFront: 0, correctFront: 0,
        attemptsBack: 0, correctBack: 0,
        createdAt: now, updatedAt: now
      }));
      added++;
    }

    if(added===0){
      report.innerHTML = `<span class="warn">Nichts importiert.</span>`;
      return;
    }
    saveCards();
    report.innerHTML = `<span class="ok">Fertig:</span> ${added} hinzugef√ºgt` + (skipped ? ` ¬∑ <span class="warn">${skipped} √ºbersprungen</span>` : "");
  }

  /******************************************************************
   * 9) Learn helpers
   ******************************************************************/
  function labelMode(m){
    if(m==="all") return "Alle";
    if(m==="unknown") return "Nicht gewusst";
    if(m==="problem") return "Problemkarten";
    if(m==="star0") return "Fach 0";
    if(m==="star1") return "Fach 1";
    if(m==="star2") return "Fach 2";
    if(m==="star3") return "Fach 3";
    if(m==="star4") return "Fach 4";
    if(m==="star5") return "Fach 5";
    if(m==="star6") return "Fach 6 (rot)";
    if(m==="star7") return "Fach 7 (rot)";
    return "‚Äî";
  }
  function labelDir(d){
    if(d==="front") return "DE‚ÜíES";
    if(d==="back") return "ES‚ÜíDE";
    if(d==="mixed") return "Gemischt";
    return "‚Äî";
  }

  function passLearnMode(card){
    const c = ensureCardShape(card);
    const m = ui.learnMode;
    if(m==="all") return true;

    if(m==="unknown"){
      if(ui.direction==="front") return c.lastResultFront==="unknown";
      if(ui.direction==="back")  return c.lastResultBack==="unknown";
      return (c.lastResultFront==="unknown" || c.lastResultBack==="unknown");
    }

    if(m==="problem"){
      const maxAcc = ui.problemThreshold;
      return isProblemCard(c, ui.direction==="mixed" ? "mixed" : ui.direction, maxAcc, 3);
    }

    if(m==="star0") return normalizeStars(c.stars)===0;
    if(m==="star1") return normalizeStars(c.stars)===1;
    if(m==="star2") return normalizeStars(c.stars)===2;
    if(m==="star3") return normalizeStars(c.stars)===3;
    if(m==="star4") return normalizeStars(c.stars)===4;
    if(m==="star5") return normalizeStars(c.stars)===5;
    if(m==="star6") return normalizeStars(c.stars)===6;
    if(m==="star7") return normalizeStars(c.stars)===7;
    return true;
  }

  function updateLearnStatusHint(){
    if(!ui.currentCard) return;
    const dirLabel = (ui.currentSide==="front") ? "DE‚ÜíES" : "ES‚ÜíDE";
    const res = (ui.currentSide==="front") ? ui.currentCard.lastResultFront : ui.currentCard.lastResultBack;
    const acc = accuracyFor(ui.currentCard, ui.currentSide);
    document.getElementById("statusHint").textContent =
      `Status ${dirLabel}: ${res==="known" ? "gewusst ‚úÖ" : "nicht gewusst ‚ùå"} ¬∑ Fach: ${ui.currentCard.stars} ¬∑ ${acc===null ? "‚Äî" : (acc+"%")}`;
    document.getElementById("specialHint").style.display = (ui.currentCard.stars===6||ui.currentCard.stars===7) ? "" : "none";
  }

  function startQuiz(){
    ui.learnMode = document.getElementById("learnMode").value;
    ui.direction = document.getElementById("direction").value;
    ui.order = document.getElementById("order").value;

    const th = Number(document.getElementById("problemThreshold").value);
    ui.problemThreshold = Number.isFinite(th) ? th : 60;

    let pool = cards.map(ensureCardShape).filter(passLearnMode);
    pool = sortList(pool, ui.order);

    const hint = document.getElementById("learnHint");
    const flashCard = document.getElementById("flashCard");
    const bar = document.getElementById("learnBar");

    if(pool.length===0){
      hint.innerHTML = `<span class="warn">Keine Karten gefunden.</span>`;
      flashCard.style.display = "none";
      bar.style.display="none";
      document.body.classList.remove("learnFullscreen");
      document.getElementById("progressPill").textContent = "0 / 0";
      document.getElementById("modePill").textContent = "Modus: ‚Äî";
      document.getElementById("dirPill").textContent = "Richtung: ‚Äî";
      return;
    }

    ui.quizList = pool.map(c=>c.id);
    ui.quizIndex = 0;
    ui.currentCard = null;
    ui.revealed = false;

    hint.textContent = "";
    flashCard.style.display="";
    bar.style.display="";

    document.getElementById("modePill").textContent = "Modus: " + labelMode(ui.learnMode);
    document.getElementById("dirPill").textContent = "Richtung: " + labelDir(ui.direction);

    document.body.classList.add("learnFullscreen");

    showCurrent();
  }

  function showCurrent(){
    const id = ui.quizList[ui.quizIndex];
    const card = cards.find(c=>c.id===id);
    if(!card){ nextCard(); return; }

    ui.currentCard = ensureCardShape(card);

    let side = ui.direction;
    if(ui.direction === "mixed"){
      side = Math.random() < 0.5 ? "front" : "back";
    }
    ui.currentSide = side;

    const showFront = (side === "front");

    document.getElementById("progressPill").textContent = `${ui.quizIndex+1} / ${ui.quizList.length}`;
    document.getElementById("quizPrompt").textContent = showFront ? ui.currentCard.front : ui.currentCard.back;

    const ansEl = document.getElementById("quizAnswer");
    ansEl.textContent = showFront ? ui.currentCard.back : ui.currentCard.front;

    ui.revealed = false;
    ansEl.classList.remove("show");

    document.querySelectorAll("#flashStars .starBtn").forEach(btn=>{
      const n = Number(btn.dataset.stars);
      btn.classList.toggle("active", n === normalizeStars(ui.currentCard.stars));
    });

    updateLearnStatusHint();
  }

  function toggleReveal(){
    if(!ui.currentCard) return;
    ui.revealed = !ui.revealed;
    document.getElementById("quizAnswer").classList.toggle("show", ui.revealed);
  }

  function nextCard(){
    if(ui.quizList.length===0) return;
    ui.quizIndex++;
    if(ui.quizIndex >= ui.quizList.length){
      document.getElementById("learnHint").textContent = "Fertig ‚úÖ";
      document.getElementById("flashCard").style.display="none";
      document.getElementById("learnBar").style.display="none";
      document.getElementById("progressPill").textContent = `${ui.quizList.length} / ${ui.quizList.length}`;
      return;
    }
    showCurrent();
  }

  // Leitner+ Logik:
  // - F√§cher 0‚Äì5: automatisch (gewusst => -1, nicht gewusst => +1)
  // - F√§cher 6‚Äì7: NICHT automatisch bewegen (bleibt), nur manuell per Fach-Klick
  function markKnown(known){
    if(!ui.currentCard) return;

    const idx = cards.findIndex(c=>c.id===ui.currentCard.id);
    if(idx<0) return;

    const side = ui.currentSide; // "front" oder "back"
    const key = (side==="front") ? "lastResultFront" : "lastResultBack";
    cards[idx][key] = known ? "known" : "unknown";

    // Stats pro Karte
    if(side==="front"){
      cards[idx].attemptsFront += 1;
      if(known) cards[idx].correctFront += 1;
    }else{
      cards[idx].attemptsBack += 1;
      if(known) cards[idx].correctBack += 1;
    }
    cards[idx].lastSeenAt = Date.now();

    // Global stats
    stats.totalAttempts += 1;
    if(known) stats.totalCorrect += 1;
    stats.lastLearnAt = nowIso();
    stats.recent.push({ts: Date.now(), correct: known ? 1 : 0});
    stats.recent = stats.recent.slice(-200);
    persistStats();

    // Fach-Logik
    const cur = normalizeStars(cards[idx].stars);
    if(cur <= 5){
      const next = known ? Math.max(0, cur - 1) : Math.min(5, cur + 1);
      cards[idx].stars = next;
    }else{
      // Fach 6/7: bleibt
      cards[idx].stars = cur;
    }

    cards[idx].updatedAt = Date.now();
    persistCardsOnly();

    updateStatusLine();
    renderKpis();
    renderCardList();

    if(ui.learnMode === "unknown"){
      let stillUnknown = true;
      if(ui.direction==="front") stillUnknown = (cards[idx].lastResultFront==="unknown");
      else if(ui.direction==="back") stillUnknown = (cards[idx].lastResultBack==="unknown");
      else stillUnknown = (cards[idx].lastResultFront==="unknown" || cards[idx].lastResultBack==="unknown");

      if(!stillUnknown){
        const delId = cards[idx].id;
        ui.quizList = ui.quizList.filter(id => id !== delId);

        if(ui.quizList.length === 0){
          document.getElementById("learnHint").textContent = "Fertig ‚úÖ";
          document.getElementById("flashCard").style.display="none";
          document.getElementById("learnBar").style.display="none";
          document.getElementById("progressPill").textContent = "0 / 0";
          ui.currentCard = null;
          return;
        }
        if(ui.quizIndex >= ui.quizList.length) ui.quizIndex = ui.quizList.length - 1;
        showCurrent();
        return;
      }
    }

    nextCard();
  }

  function setStars(n){
    if(!ui.currentCard) return;
    const idx = cards.findIndex(c=>c.id===ui.currentCard.id);
    if(idx<0) return;

    cards[idx].stars = normalizeStars(n);
    cards[idx].updatedAt = Date.now();
    persistCardsOnly();

    document.querySelectorAll("#flashStars .starBtn").forEach(btn=>{
      btn.classList.toggle("active", Number(btn.dataset.stars)===normalizeStars(n));
    });

    ui.currentCard = ensureCardShape(cards[idx]);

    updateLearnStatusHint();
    updateStatusLine();
    renderKpis();
    renderCardList();
  }

  function editCurrentInLearn(){
    if(!ui.currentCard) return;
    const idx = cards.findIndex(c=>c.id===ui.currentCard.id);
    if(idx<0) return;

    const nf = prompt("Vorderseite bearbeiten:", cards[idx].front);
    if(nf===null) return;
    const nb = prompt("R√ºckseite bearbeiten:", cards[idx].back);
    if(nb===null) return;

    cards[idx].front = nf.trim();
    cards[idx].back  = nb.trim();
    cards[idx].updatedAt = Date.now();
    saveCards();

    showCurrent();
  }

  function deleteCurrentFromLearn(){
    if(!ui.currentCard) return;
    const shown = `\n\nVorderseite:\n${ui.currentCard.front}\n\nR√ºckseite:\n${ui.currentCard.back}\n`;
    if(!confirm("Diese Karte wirklich l√∂schen?" + shown)) return;

    const delId = ui.currentCard.id;
    cards = cards.filter(c => c.id !== delId);
    ui.quizList = ui.quizList.filter(id => id !== delId);
    saveCards();

    if(ui.quizList.length === 0){
      document.getElementById("learnHint").textContent = "Keine Karten mehr in dieser Runde.";
      document.getElementById("flashCard").style.display="none";
      document.getElementById("learnBar").style.display="none";
      document.getElementById("progressPill").textContent = "0 / 0";
      ui.currentCard = null;
      return;
    }

    if(ui.quizIndex >= ui.quizList.length) ui.quizIndex = ui.quizList.length - 1;
    showCurrent();
  }

  /******************************************************************
   * 10) Export/Import
   ******************************************************************/
  function downloadText(filename, text){
    const blob = new Blob([text], {type: "text/plain;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }
  function downloadJson(filename, obj){
    const text = JSON.stringify(obj, null, 2);
    const blob = new Blob([text], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }
  function sanitizeForTxt(s){
    return String(s ?? "").replace(/\r?\n/g, " ").trim();
  }
  function toAppTxtLines(list){
    return list.map(c => [
      sanitizeForTxt(c.front),
      sanitizeForTxt(c.back),
      String(normalizeStars(c.stars)),
      normResult(c.lastResultFront),
      normResult(c.lastResultBack)
    ].join(";"));
  }
  function makeFileName(base, ext){
    const d = new Date();
    const pad = (n)=>String(n).padStart(2,"0");
    const stamp = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}`;
    return `${base}_${stamp}.${ext}`;
  }
  function exportTxtAll(){
    const out = toAppTxtLines(cards.map(ensureCardShape)).join("\n");
    document.getElementById("exportOut").value = out;
    downloadText(makeFileName("vokabeln_alle", "txt"), out);
  }
  function exportTxtFav(){
    const fav = cards.map(ensureCardShape).filter(c => normalizeStars(c.stars) > 0);
    const out = toAppTxtLines(fav).join("\n");
    document.getElementById("exportOut").value = out;
    downloadText(makeFileName("vokabeln_favoriten", "txt"), out);
  }
  function exportJsonToField(){
    document.getElementById("exportOut").value = JSON.stringify(cards, null, 2);
  }
  function backupDownload(){
    const payload = {
      app:"vokabeltrainer",
      version:3,
      exportedAt:new Date().toISOString(),
      stats,
      cards: cards.map(ensureCardShape)
    };
    downloadJson(makeFileName("vokabeltrainer_backup","json"), payload);
  }
  function restoreFromFile(){
    const input = document.getElementById("fileRestore");
    const report = document.getElementById("restoreReport");
    report.textContent = "";

    const file = input.files && input.files[0];
    if(!file){ report.innerHTML = `<span class="warn">Keine Datei ausgew√§hlt.</span>`; return; }

    const reader = new FileReader();
    reader.onload = () => {
      try{
        const parsed = JSON.parse(String(reader.result || ""));
        let incoming = null;
        let incomingStats = null;

        if(Array.isArray(parsed)) incoming = parsed;
        else if(parsed && Array.isArray(parsed.cards)) incoming = parsed.cards;
        if(parsed && parsed.stats && typeof parsed.stats === "object") incomingStats = parsed.stats;

        if(!Array.isArray(incoming)){
          report.innerHTML = `<span class="warn">Ung√ºltiges Backup-Format.</span>`;
          return;
        }

        const cleaned = [];
        for(const c of incoming){
          const front = (c && typeof c.front==="string") ? c.front.trim() : "";
          const back  = (c && typeof c.back==="string") ? c.back.trim() : "";
          if(!front || !back) continue;

          cleaned.push(ensureCardShape({
            id: (c && typeof c.id==="string" && c.id) ? c.id : uid(),
            front, back,
            stars: normalizeStars(c.stars),
            lastResultFront: normResult(c.lastResultFront || c.lastResult || "unknown"),
            lastResultBack:  normResult(c.lastResultBack  || c.lastResult || "unknown"),
            attemptsFront: Number.isFinite(c.attemptsFront) ? c.attemptsFront : 0,
            correctFront:  Number.isFinite(c.correctFront)  ? c.correctFront  : 0,
            attemptsBack:  Number.isFinite(c.attemptsBack)  ? c.attemptsBack  : 0,
            correctBack:   Number.isFinite(c.correctBack)   ? c.correctBack   : 0,
            lastSeenAt: Number.isFinite(c.lastSeenAt) ? c.lastSeenAt : 0,
            createdAt: (c && Number.isFinite(c.createdAt)) ? c.createdAt : Date.now(),
            updatedAt: (c && Number.isFinite(c.updatedAt)) ? c.updatedAt : Date.now(),
          }));
        }

        const seen = new Set();
        const unique = [];
        for(const c of cleaned){
          if(seen.has(c.id)) continue;
          seen.add(c.id);
          unique.push(c);
        }

        cards = unique;

        if(incomingStats){
          stats = Object.assign(loadStats(), incomingStats);
          stats.recent = Array.isArray(stats.recent) ? stats.recent.slice(-200) : [];
          persistStats();
        }

        saveCards();
        report.innerHTML = `<span class="ok">Wiederhergestellt:</span> ${cards.length} Karten`;
      }catch(e){
        report.innerHTML = `<span class="warn">Fehler beim Einlesen:</span> ${String(e)}`;
      }finally{
        input.value = "";
      }
    };
    reader.readAsText(file);
  }

  function resetAll(){
    if(confirm("Wirklich ALLES l√∂schen? Das kann man nicht r√ºckg√§ngig machen.")){
      cards = [];
      for(const key of LEGACY_KEYS){
        try{ localStorage.removeItem(key); }catch{}
      }
      localStorage.removeItem(STATS_KEY);
      refreshAll();
      alert("Alles gel√∂scht.");
    }
  }

  /******************************************************************
   * 11) Statistik UI + Charts
   ******************************************************************/
  function renderStats(){
    const attempts = stats.totalAttempts || 0;
    const correct = stats.totalCorrect || 0;
    const acc = attempts ? Math.round((correct/attempts)*100) : 0;

    document.getElementById("statTotalAttempts").textContent = String(attempts);
    document.getElementById("statTotalAttemptsSub").textContent = `Richtig: ${correct} ¬∑ Falsch: ${Math.max(0, attempts-correct)}`;

    document.getElementById("statAccuracy").textContent = `${acc}%`;
    document.getElementById("statAccuracySub").textContent = attempts ? `Seit: ${new Date(stats.createdAt).toLocaleString()}` : "Noch keine Lern-Daten.";

    const pCount = cards.filter(c=>isProblemCard(c,"mixed",60,3)).length;
    document.getElementById("statProblemCount").textContent = String(pCount);

    const last = stats.lastLearnAt ? new Date(stats.lastLearnAt).toLocaleString() : "‚Äî";
    document.getElementById("statLastLearn").textContent = last;
    document.getElementById("statLastLearnSub").textContent =
      stats.lastLearnAt ? `Letzte 10 Antworten: ${last10Acc()}%` : "Noch nicht gelernt.";
  }

  function last10Acc(){
    const r = stats.recent.slice(-10);
    if(!r.length) return 0;
    const sum = r.reduce((a,x)=>a+(x.correct?1:0),0);
    return Math.round((sum/r.length)*100);
  }

  function drawCharts(){
    drawBinsChart();
    drawAccuracyChart();
  }

  function drawBinsChart(){
    const canvas = document.getElementById("chartBins");
    const ctx = canvas.getContext("2d");
    ctx.clearRect(0,0,canvas.width,canvas.height);

    const bins = countsByStars();
    const values = [];
    for(let i=0;i<=7;i++) values.push(bins[i]||0);

    const max = Math.max(1, ...values);
    const pad = 30;
    const w = canvas.width;
    const h = canvas.height;
    const barW = (w - pad*2) / values.length;

    // Axes
    ctx.beginPath();
    ctx.moveTo(pad, h-pad);
    ctx.lineTo(w-pad, h-pad);
    ctx.stroke();

    for(let i=0;i<values.length;i++){
      const v = values[i];
      const bh = Math.round((v/max) * (h - pad*2));
      const x = pad + i*barW + 8;
      const y = (h-pad) - bh;

      // Bar (6/7 gestrichelt als Hinweis)
      ctx.beginPath();
      ctx.rect(x, y, barW-16, bh);
      ctx.stroke();

      // Label
      ctx.fillText(String(i), x + (barW-16)/2 - 3, h - 10);
      ctx.fillText(String(v), x + 2, y - 6);
      if(i===6 || i===7){
        ctx.fillText("!", x + (barW-16)/2 - 2, y + 14);
      }
    }
  }

  function drawAccuracyChart(){
    const canvas = document.getElementById("chartAccuracy");
    const ctx = canvas.getContext("2d");
    ctx.clearRect(0,0,canvas.width,canvas.height);

    const pad = 30;
    const w = canvas.width;
    const h = canvas.height;

    const points = stats.recent.slice(-100);
    if(points.length === 0){
      ctx.fillText("Noch keine Lern-Daten.", pad, pad+10);
      return;
    }

    // Convert to rolling accuracy
    const win = 10;
    const series = points.map((_, i)=>{
      const start = Math.max(0, i - win + 1);
      const seg = points.slice(start, i+1);
      const sum = seg.reduce((a,x)=>a+(x.correct?1:0),0);
      return Math.round((sum/seg.length)*100);
    });

    const maxY = 100;
    const minY = 0;

    // Axes
    ctx.beginPath();
    ctx.moveTo(pad, h-pad);
    ctx.lineTo(w-pad, h-pad);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(pad, pad);
    ctx.lineTo(pad, h-pad);
    ctx.stroke();

    // Y labels
    ctx.fillText("100%", 2, pad+4);
    ctx.fillText("0%", 10, h-pad);

    // Line
    const stepX = (w - pad*2) / Math.max(1, (series.length-1));
    ctx.beginPath();
    series.forEach((v,i)=>{
      const x = pad + i*stepX;
      const y = pad + (1 - ((v-minY)/(maxY-minY))) * (h - pad*2);
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();

    // Last value
    const last = series[series.length-1];
    ctx.fillText(`√ò(10): ${last}%`, w-pad-90, pad+10);
  }

  function renderProblemList(dir, maxAcc){
    const listEl = document.getElementById("problemList");
    listEl.innerHTML = "";

    const filtered = cards
      .map(ensureCardShape)
      .filter(c => isProblemCard(c, dir, Number(maxAcc), 3))
      .map(c=>{
        const acc = (dir==="mixed")
          ? Math.min(
              (c.attemptsFront>=3 ? Math.round((c.correctFront/c.attemptsFront)*100) : 100),
              (c.attemptsBack>=3 ? Math.round((c.correctBack/c.attemptsBack)*100) : 100)
            )
          : (dir==="front" ? accuracyFor(c,"front") : accuracyFor(c,"back"));
        return {c, acc: acc ?? 101};
      })
      .sort((a,b)=>a.acc-b.acc)
      .slice(0, 30);

    if(filtered.length===0){
      listEl.innerHTML = `<div class="muted small">Keine Problemkarten nach dieser Definition.</div>`;
      return;
    }

    filtered.forEach(({c, acc})=>{
      const item = document.createElement("div");
      item.className="item";
      const title = document.createElement("div");
      title.className="front";
      title.textContent = c.front;

      const sub = document.createElement("div");
      sub.className="back";
      sub.textContent = c.back;

      const meta = document.createElement("div");
      meta.className="row";
      meta.style.marginTop="8px";

      const aF = accuracyFor(c,"front");
      const aB = accuracyFor(c,"back");

      const p1 = document.createElement("span");
      p1.className="pill";
      p1.textContent = `DE‚ÜíES: ${aF===null?"‚Äî":aF+"%"} (${c.attemptsFront}√ó)`;

      const p2 = document.createElement("span");
      p2.className="pill";
      p2.textContent = `ES‚ÜíDE: ${aB===null?"‚Äî":aB+"%"} (${c.attemptsBack}√ó)`;

      const p3 = document.createElement("span");
      p3.className="pill";
      p3.textContent = `Fach: ${c.stars}`;

      meta.appendChild(p1); meta.appendChild(p2); meta.appendChild(p3);

      const actions = document.createElement("div");
      actions.className="row";
      actions.style.marginTop="8px";

      const btnLearn = document.createElement("button");
      btnLearn.type="button";
      btnLearn.textContent="‚û°Ô∏è In Abfrage √∂ffnen";
      btnLearn.addEventListener("click", ()=>{
        setActiveTab("learn");
        document.getElementById("learnMode").value = "problem";
        document.getElementById("direction").value = (dir==="mixed" ? "mixed" : dir);
        document.getElementById("problemThreshold").value = String(maxAcc);
        document.getElementById("problemThresholdLabel").textContent = String(maxAcc) + "%";
        updateProblemControlsVisibility();
        startQuiz();
      });

      actions.appendChild(btnLearn);

      item.appendChild(title);
      item.appendChild(sub);
      item.appendChild(meta);
      item.appendChild(actions);
      listEl.appendChild(item);
    });
  }

  /******************************************************************
   * 12) Google Drive Auto-Backup (Client-side OAuth, appDataFolder)
   ******************************************************************/
  function loadDriveCfg(){
    const raw = localStorage.getItem(DRIVE_CFG_KEY);
    const parsed = safeParse(raw);
    return {
      apiKey: (parsed && typeof parsed.apiKey==="string") ? parsed.apiKey : "",
      clientId: (parsed && typeof parsed.clientId==="string") ? parsed.clientId : ""
    };
  }
  function saveDriveCfg(){
    localStorage.setItem(DRIVE_CFG_KEY, JSON.stringify(driveCfg));
  }
  function loadDriveAutoEnabled(){
    return localStorage.getItem(DRIVE_AUTO_KEY) === "1";
  }
  function saveDriveAutoEnabled(v){
    localStorage.setItem(DRIVE_AUTO_KEY, v ? "1" : "0");
  }

  function createDriveState(){
    return {
      tokenClient: null,
      accessToken: null,
      connected: false,
      autoEnabled: loadDriveAutoEnabled(),
      lastBackupAt: 0,
      backupTimer: null,
      pendingReason: null
    };
  }

  function driveConfigured(){
    return !!(driveCfg.apiKey && driveCfg.clientId);
  }

  function setDriveStatus(msg){
    document.getElementById("driveStatus").textContent = msg;
    updateStatusLine();
  }

  function initDriveTokenClient(){
    if(!driveConfigured()){
      setDriveStatus("Drive: Konfiguration fehlt (API Key + Client ID)");
      return false;
    }
    if(!window.google || !google.accounts || !google.accounts.oauth2){
      setDriveStatus("Drive: Google OAuth Library l√§dt noch‚Ä¶ (bitte kurz warten)");
      return false;
    }

    // Scope: appDataFolder reicht f√ºr verstecktes Backup
    // https://developers.google.com/workspace/drive/api/guides/appdata
    const scope = "https://www.googleapis.com/auth/drive.appdata";

    drive.tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: driveCfg.clientId,
      scope,
      callback: (resp) => {
        if(resp && resp.access_token){
          drive.accessToken = resp.access_token;
          drive.connected = true;
          setDriveStatus("Drive: verbunden ‚úÖ");
        }else{
          drive.connected = false;
          setDriveStatus("Drive: kein Token erhalten");
        }
      }
    });
    return true;
  }

  function connectDrive(){
    if(!initDriveTokenClient()) return;
    try{
      drive.tokenClient.requestAccessToken({prompt: "consent"});
    }catch(e){
      setDriveStatus("Drive: Auth-Fehler: " + String(e));
    }
  }

  function disconnectDrive(){
    drive.accessToken = null;
    drive.connected = false;
    setDriveStatus("Drive: getrennt");
  }

  function multipartRelatedBody(metadataObj, jsonText){
    const boundary = "----vokabeltrainer_" + Math.random().toString(16).slice(2);
    const meta = JSON.stringify(metadataObj);
    const delimiter = "--" + boundary;
    const close = delimiter + "--";

    const body =
      delimiter + "\r\n" +
      "Content-Type: application/json; charset=UTF-8\r\n\r\n" +
      meta + "\r\n" +
      delimiter + "\r\n" +
      "Content-Type: application/json; charset=UTF-8\r\n\r\n" +
      jsonText + "\r\n" +
      close;

    return {body, boundary};
  }

  async function driveListExistingFileId(){
    // List in appDataFolder
    const q = `name='${DRIVE_FILE_NAME.replace(/'/g,"\\'")}' and trashed=false`;
    const url = "https://www.googleapis.com/drive/v3/files"
      + "?spaces=appDataFolder"
      + "&fields=files(id,name,modifiedTime)"
      + "&q=" + encodeURIComponent(q);

    const res = await fetch(url, {
      headers: {
        "Authorization": "Bearer " + drive.accessToken,
        "X-Goog-Api-Key": driveCfg.apiKey
      }
    });
    if(!res.ok) throw new Error("Drive list failed: " + res.status);
    const data = await res.json();
    const file = (data && data.files && data.files[0]) ? data.files[0] : null;
    return file ? file.id : null;
  }

  async function driveUploadBackupNow(reason){
    if(!driveConfigured()){
      setDriveStatus("Drive: Konfiguration fehlt (API Key + Client ID)");
      return;
    }
    if(!drive.connected || !drive.accessToken){
      setDriveStatus("Drive: nicht verbunden (bitte verbinden)");
      return;
    }

    const payload = {
      app:"vokabeltrainer",
      version:3,
      exportedAt:new Date().toISOString(),
      stats,
      cards: cards.map(ensureCardShape)
    };
    const jsonText = JSON.stringify(payload, null, 2);

    setDriveStatus("Drive: Backup l√§uft‚Ä¶");

    try{
      const existingId = await driveListExistingFileId();

      if(existingId){
        // Update via upload endpoint
        const meta = { name: DRIVE_FILE_NAME };
        const {body, boundary} = multipartRelatedBody(meta, jsonText);

        const url = "https://www.googleapis.com/upload/drive/v3/files/" + encodeURIComponent(existingId)
          + "?uploadType=multipart";

        const res = await fetch(url, {
          method: "PATCH",
          headers: {
            "Authorization": "Bearer " + drive.accessToken,
            "X-Goog-Api-Key": driveCfg.apiKey,
            "Content-Type": "multipart/related; boundary=" + boundary
          },
          body
        });
        if(!res.ok) throw new Error("Drive update failed: " + res.status);

      }else{
        // Create in appDataFolder
        // parents: ["appDataFolder"]  (https://developers.google.com/workspace/drive/api/guides/appdata)
        const meta = { name: DRIVE_FILE_NAME, parents: ["appDataFolder"] };
        const {body, boundary} = multipartRelatedBody(meta, jsonText);

        const url = "https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart";

        const res = await fetch(url, {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + drive.accessToken,
            "X-Goog-Api-Key": driveCfg.apiKey,
            "Content-Type": "multipart/related; boundary=" + boundary
          },
          body
        });
        if(!res.ok) throw new Error("Drive create failed: " + res.status);
      }

      drive.lastBackupAt = Date.now();
      setDriveStatus("Drive: Backup gespeichert ‚úÖ" + (reason ? ` (${reason})` : ""));
      updateStatusLine();
    }catch(e){
      setDriveStatus("Drive: Backup fehlgeschlagen: " + String(e));
    }
  }

  function scheduleAutoDriveBackup(reason){
    drive.autoEnabled = loadDriveAutoEnabled();
    if(!drive.autoEnabled) return;
    if(!driveConfigured()) return;
    if(!drive.connected) return;

    const minIntervalMs = 2 * 60 * 1000; // max alle 2 Minuten
    const now = Date.now();
    const wait = Math.max(0, (drive.lastBackupAt + minIntervalMs) - now);

    drive.pendingReason = reason || drive.pendingReason || "auto";

    if(drive.backupTimer) return; // bereits geplant

    drive.backupTimer = setTimeout(async ()=>{
      drive.backupTimer = null;
      const r = drive.pendingReason || "auto";
      drive.pendingReason = null;
      await driveUploadBackupNow(r);
    }, wait);
  }

  /******************************************************************
   * 13) Refresh all
   ******************************************************************/
  function refreshAll(){
    updateStatusLine();
    renderKpis();
    renderCardList();
    if(ui.tab==="stats"){
      renderStats();
      drawCharts();
    }
  }

  /******************************************************************
   * 14) UI wiring
   ******************************************************************/
  document.getElementById("tabManage").addEventListener("click", ()=>setActiveTab("manage"));
  document.getElementById("tabLearn").addEventListener("click", ()=>setActiveTab("learn"));
  document.getElementById("tabData").addEventListener("click", ()=>setActiveTab("data"));
  document.getElementById("tabStats").addEventListener("click", ()=>setActiveTab("stats"));

  document.getElementById("btnBackToManage").addEventListener("click", ()=>{
    document.body.classList.remove("learnFullscreen");
    setActiveTab("manage");
  });
  document.getElementById("btnBackToManage2").addEventListener("click", ()=>setActiveTab("manage"));
  document.getElementById("btnBackToManage3").addEventListener("click", ()=>setActiveTab("manage"));

  document.getElementById("btnAdd").addEventListener("click", ()=>addCard(false));
  document.getElementById("btnAddStay").addEventListener("click", ()=>addCard(true));
  document.querySelectorAll("#newStars .starBtn").forEach(btn=>{
    btn.addEventListener("click", ()=> setNewStars(Number(btn.dataset.stars)));
  });

  document.getElementById("btnSetUnknownFront").addEventListener("click", ()=> setNewResultFront("unknown"));
  document.getElementById("btnSetKnownFront").addEventListener("click", ()=> setNewResultFront("known"));
  document.getElementById("btnSetUnknownBack").addEventListener("click", ()=> setNewResultBack("unknown"));
  document.getElementById("btnSetKnownBack").addEventListener("click", ()=> setNewResultBack("known"));

  document.getElementById("btnBulkAdd").addEventListener("click", bulkAdd);
  document.getElementById("btnBulkClear").addEventListener("click", ()=>{
    document.getElementById("bulkEntry").value="";
    document.getElementById("bulkReport").textContent="";
  });
  document.getElementById("search").addEventListener("input", e=>{ ui.search=e.target.value; renderCardList(); });
  document.getElementById("filter").addEventListener("change", e=>{ ui.filter=e.target.value; renderCardList(); });

  document.getElementById("btnStart").addEventListener("click", startQuiz);
  document.getElementById("flashCard").addEventListener("click", toggleReveal);

  document.getElementById("btnKnown").addEventListener("click", ()=>markKnown(true));
  document.getElementById("btnUnknown").addEventListener("click", ()=>markKnown(false));
  document.getElementById("btnDelete").addEventListener("click", deleteCurrentFromLearn);
  document.getElementById("btnEditLearn").addEventListener("click", editCurrentInLearn);

  document.querySelectorAll("#flashStars .starBtn").forEach(btn=>{
    btn.addEventListener("click", ()=> setStars(Number(btn.dataset.stars)));
  });

  document.getElementById("btnBackupJson").addEventListener("click", backupDownload);
  document.getElementById("btnRestoreJson").addEventListener("click", restoreFromFile);
  document.getElementById("btnExportTxtAll").addEventListener("click", exportTxtAll);
  document.getElementById("btnExportTxtFav").addEventListener("click", exportTxtFav);
  document.getElementById("btnExportJson").addEventListener("click", exportJsonToField);
  document.getElementById("btnReset").addEventListener("click", resetAll);

  // Stats UI
  document.getElementById("btnRedrawCharts1").addEventListener("click", drawCharts);
  document.getElementById("btnClearStats").addEventListener("click", ()=>{
    if(confirm("Statistik wirklich zur√ºcksetzen? (Karten bleiben erhalten)")){
      resetStats();
    }
  });
  document.getElementById("btnShowProblems").addEventListener("click", ()=>{
    const dir = document.getElementById("statProblemDir").value;
    const maxAcc = document.getElementById("statProblemMaxAcc").value;
    renderProblemList(dir, maxAcc);
  });

  // Problem controls visibility
  function updateProblemControlsVisibility(){
    const m = document.getElementById("learnMode").value;
    document.getElementById("problemControls").style.display = (m==="problem") ? "" : "none";
  }
  document.getElementById("learnMode").addEventListener("change", ()=>{
    updateProblemControlsVisibility();
  });
  document.getElementById("problemThreshold").addEventListener("input", (e)=>{
    const v = Number(e.target.value);
    document.getElementById("problemThresholdLabel").textContent = v + "%";
  });

  // Google Drive UI wiring
  document.getElementById("driveApiKey").value = driveCfg.apiKey || "";
  document.getElementById("driveClientId").value = driveCfg.clientId || "";
  document.getElementById("driveAutoToggle").checked = loadDriveAutoEnabled();

  document.getElementById("btnDriveSaveConfig").addEventListener("click", ()=>{
    driveCfg.apiKey = document.getElementById("driveApiKey").value.trim();
    driveCfg.clientId = document.getElementById("driveClientId").value.trim();
    saveDriveCfg();
    setDriveStatus(driveConfigured() ? "Drive: Konfiguration gespeichert" : "Drive: Konfiguration fehlt");
  });

  document.getElementById("btnDriveConnect").addEventListener("click", ()=>{
    driveCfg.apiKey = document.getElementById("driveApiKey").value.trim();
    driveCfg.clientId = document.getElementById("driveClientId").value.trim();
    saveDriveCfg();
    connectDrive();
  });

  document.getElementById("btnDriveDisconnect").addEventListener("click", disconnectDrive);

  document.getElementById("btnDriveBackupNow").addEventListener("click", ()=>{
    driveUploadBackupNow("manuell");
  });

  document.getElementById("driveAutoToggle").addEventListener("change", (e)=>{
    const enabled = !!e.target.checked;
    saveDriveAutoEnabled(enabled);
    drive.autoEnabled = enabled;
    setDriveStatus(drive.connected
      ? `Drive: verbunden ¬∑ Auto: ${enabled ? "an" : "aus"}`
      : `Drive: nicht verbunden ¬∑ Auto: ${enabled ? "an" : "aus"}`
    );
    if(enabled){
      scheduleAutoDriveBackup("auto-on");
    }
  });

  /******************************************************************
   * 15) Init
   ******************************************************************/
  document.getElementById("jsAlive").textContent = "JS: l√§uft ‚úÖ";
  setNewStars(0);
  setNewResultFront("unknown");
  setNewResultBack("unknown");
  document.getElementById("filter").value = "all";

  // Initial problem UI
  updateProblemControlsVisibility();
  document.getElementById("problemThresholdLabel").textContent =
    document.getElementById("problemThreshold").value + "%";

  // Drive initial status
  setDriveStatus(driveConfigured() ? "Drive: bereit (noch nicht verbunden)" : "Drive: Konfiguration fehlt");

  refreshAll();

})();
</script>
</body>
</html>
